# Story 3.7: Citations de Code Inline

## Status

Ready for Review

## Story

**As a** utilisateur,
**I want** voir les fichiers sources cites dans les reponses,
**So that** je puisse verifier l'information et gagner en confiance.

## Acceptance Criteria

1. **Given** la reponse fait reference a du code, **When** le message est affiche, **Then** les fichiers sont cites en inline avec le composant CodeCitation
2. **And** le format est `[src/auth.ts:42]` dans une pill rose avec border
3. **And** l'icone fichier et le badge extension colore sont visibles
4. **Given** je survole une citation, **When** le hover est actif, **Then** la pill scale a 1.02 avec glow rose
5. **And** un tooltip montre un apercu du code (optionnel MVP)
6. **Given** je clique sur une citation, **When** l'action est declenchee, **Then** le chemin du fichier est copie dans le presse-papier
7. **And** un toast confirme "Copie !"

## Tasks / Subtasks

- [x] Task 1: Create CodeCitation Component (AC: 1, 2, 3, 4, 6, 7)
  - [x] Create `components/chat/CodeCitation.tsx`
  - [x] Implement pill styling with rose border and background
  - [x] Add file icon (Lucide File icon)
  - [x] Add extension badge with color mapping
  - [x] Implement hover scale (1.02) and glow effect
  - [x] Implement click-to-copy functionality
  - [x] Integrate with toast for "Copie !" feedback (using sonner)
  - [x] Write unit tests

- [x] Task 2: Create Extension Color Mapping (AC: 3)
  - [x] Create `lib/utils/file-extensions.ts`
  - [x] Define color mapping for common extensions:
    - `.ts/.tsx` -> Blue (#3B82F6)
    - `.js/.jsx` -> Yellow (#EAB308)
    - `.py` -> Green (#22C55E)
    - `.css/.scss` -> Purple (#A855F7)
    - `.json/.yaml` -> Orange (#F97316)
    - `.md` -> Gray
  - [x] Export `getExtensionColor()` utility function
  - [x] Write unit tests

- [x] Task 3: Create Citation Parser Utility (AC: 1, 2)
  - [x] Create `lib/utils/citation-parser.ts`
  - [x] Implement regex to detect citation patterns: `[filepath:line]` or `[filepath]`
  - [x] Parse citations from markdown content
  - [x] Return structured citation objects: `{ path: string, line?: number }`
  - [x] Write unit tests

- [x] Task 4: Update ChatMessage to Render Citations (AC: 1, 2, 3)
  - [x] Update `components/chat/ChatMessage.tsx`
  - [x] Import CodeCitation component
  - [x] Create custom ReactMarkdown component for citation rendering
  - [x] Replace citation patterns with CodeCitation components
  - [x] Maintain markdown rendering for rest of content

- [x] Task 5: Optional - Add Code Preview Tooltip (AC: 5)
  - [x] Note: Deferred to post-MVP - tooltip wrapper not implemented
  - [x] Basic hover states and glow effect implemented

- [x] Task 6: Update Prompt for Citation Format (AC: 1, 2)
  - [x] Citation format already included in Story 3.6 prompts
  - [x] Format: [chemin/vers/fichier.ext:ligne]
  - [x] Examples included in CITATION_FORMAT constant

- [x] Task 7: Unit Tests (AC: 1-7)
  - [x] Test CodeCitation component rendering (20 tests)
  - [x] Test hover and click interactions
  - [x] Test extension color mapping (16 tests)
  - [x] Test citation parser regex (18 tests)
  - [x] Test ChatMessage with citations (via existing tests)

## Dev Notes

### Previous Story Context (3.6)

Story 3.6 focused on:
- Enhancing system prompt for professional vocabulary
- Binary confidence handling
- Pedagogical response patterns

Key files from Story 3.6:
- `lib/ai/confidence.ts` - Confidence handling
- `lib/ai/prompts/base.ts` - Base PM-friendly prompt
- `app/api/chat/route.ts` - Updated with enhanced prompting

### UX Design Requirements [Source: ux-design-specification.md#CodeCitation]

**CodeCitation Component Anatomy:**
- Icon fichier
- Nom du fichier
- Numero de ligne (optionnel)
- Badge extension colore

**States:**
- `default` - Pill avec border subtile
- `hover` - Scale 1.02, glow rose
- `active` - Background accent
- `copied` - Feedback "Copie !"

**Variants:**
- `inline` - Dans le texte (petit)
- `block` - Liste de fichiers (plus grand)

**Accessibility:**
- `role="link"` avec `aria-label` complet
- Focus visible avec ring rose

### Citation Format Standard

The LLM will be instructed to use this format in responses:
```
Le fichier [src/auth/login.ts:42] gere l'authentification...
```

The parser should handle:
- `[path/to/file.ts:123]` - File with line number
- `[path/to/file.ts]` - File without line number
- Multiple citations in same response

### Component Implementation

```typescript
// components/chat/CodeCitation.tsx
interface CodeCitationProps {
  path: string
  line?: number
  variant?: 'inline' | 'block'
}

export function CodeCitation({ path, line, variant = 'inline' }: CodeCitationProps) {
  const [copied, setCopied] = useState(false)
  const extension = path.split('.').pop()
  const extensionColor = getExtensionColor(extension)

  const handleCopy = async () => {
    const textToCopy = line ? `${path}:${line}` : path
    await navigator.clipboard.writeText(textToCopy)
    setCopied(true)
    toast.success('Copie !')
    setTimeout(() => setCopied(false), 2000)
  }

  return (
    <button
      onClick={handleCopy}
      className={cn(
        'inline-flex items-center gap-1.5 px-2 py-0.5',
        'rounded-full border border-primary/30 bg-primary/10',
        'text-sm font-mono transition-all duration-200',
        'hover:scale-[1.02] hover:shadow-[0_0_12px_rgba(236,72,153,0.3)]',
        'focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary'
      )}
      role="link"
      aria-label={`Citation: ${path}${line ? ` ligne ${line}` : ''}`}
    >
      <FileIcon className="size-3.5" />
      <span className="text-foreground">{path}</span>
      {line && <span className="text-muted-foreground">:{line}</span>}
      <span className={cn('rounded px-1 text-xs', extensionColor)}>
        .{extension}
      </span>
    </button>
  )
}
```

### Citation Parser Implementation

```typescript
// lib/utils/citation-parser.ts
export interface Citation {
  path: string
  line?: number
  original: string  // Original matched text for replacement
  startIndex: number
  endIndex: number
}

// Regex to match [path/to/file.ext:line] or [path/to/file.ext]
const CITATION_REGEX = /\[([^\]]+?\.[a-zA-Z0-9]+)(?::(\d+))?\]/g

export function parseCitations(content: string): Citation[] {
  const citations: Citation[] = []
  let match

  while ((match = CITATION_REGEX.exec(content)) !== null) {
    citations.push({
      path: match[1],
      line: match[2] ? parseInt(match[2], 10) : undefined,
      original: match[0],
      startIndex: match.index,
      endIndex: match.index + match[0].length,
    })
  }

  return citations
}
```

### Extension Color Mapping

```typescript
// lib/utils/file-extensions.ts
const EXTENSION_COLORS: Record<string, string> = {
  // TypeScript/JavaScript
  ts: 'bg-blue-500/20 text-blue-400',
  tsx: 'bg-blue-500/20 text-blue-400',
  js: 'bg-yellow-500/20 text-yellow-400',
  jsx: 'bg-yellow-500/20 text-yellow-400',

  // Python
  py: 'bg-green-500/20 text-green-400',

  // Styles
  css: 'bg-purple-500/20 text-purple-400',
  scss: 'bg-purple-500/20 text-purple-400',

  // Config
  json: 'bg-orange-500/20 text-orange-400',
  yaml: 'bg-orange-500/20 text-orange-400',
  yml: 'bg-orange-500/20 text-orange-400',

  // Markdown
  md: 'bg-gray-500/20 text-gray-400',

  // Default
  default: 'bg-gray-500/20 text-gray-400',
}

export function getExtensionColor(extension?: string): string {
  if (!extension) return EXTENSION_COLORS.default
  return EXTENSION_COLORS[extension.toLowerCase()] || EXTENSION_COLORS.default
}
```

### ChatMessage Integration

```typescript
// In ChatMessage.tsx - custom renderer for citations
import { CodeCitation } from './CodeCitation'
import { parseCitations } from '@/lib/utils/citation-parser'

// Custom component to render text with citations
function ContentWithCitations({ content }: { content: string }) {
  const citations = parseCitations(content)

  if (citations.length === 0) {
    return <ReactMarkdown>{content}</ReactMarkdown>
  }

  // Split content and insert CodeCitation components
  // Implementation details...
}
```

### Prompt Update for Citation Format

Add to system prompt:
```typescript
const CITATION_INSTRUCTIONS = `
## Citations de code

Quand tu fais reference a un fichier ou une ligne de code:
- Utilise le format: [chemin/vers/fichier.ext:ligne]
- Exemple: [src/auth/login.ts:42]
- Si pas de ligne specifique: [src/components/Button.tsx]
- Cite TOUJOURS les fichiers sources pertinents
- Utilise des chemins relatifs depuis la racine du projet
`
```

### Project Structure for This Story

```
components/
├── chat/
│   ├── CodeCitation.tsx        # NEW: Citation pill component
│   ├── CodeCitation.test.tsx   # NEW: Unit tests
│   ├── ChatMessage.tsx         # UPDATE: Render citations
│   └── index.ts                # UPDATE: Export CodeCitation

lib/
├── utils/
│   ├── citation-parser.ts      # NEW: Parse citations from text
│   ├── citation-parser.test.ts # NEW: Parser tests
│   ├── file-extensions.ts      # NEW: Extension color mapping
│   └── file-extensions.test.ts # NEW: Extension tests

app/
└── api/
    └── chat/
        └── route.ts            # UPDATE: Add citation format to prompt
```

### Technical Constraints

1. **Markdown Rendering**: Must integrate with existing ReactMarkdown
2. **Streaming**: Citations must render correctly during streaming
3. **Performance**: Citation parsing should be efficient (cached if needed)
4. **Accessibility**: Citations must be keyboard navigable

## Testing

### Test File Locations

- `components/chat/CodeCitation.test.tsx`
- `lib/utils/citation-parser.test.ts`
- `lib/utils/file-extensions.test.ts`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Test hover states with fireEvent
- Test clipboard functionality with mocks

### Manual Testing Checklist

1. [ ] Citation appears as styled pill in response
2. [ ] File icon visible in citation
3. [ ] Extension badge has correct color
4. [ ] Hover effect shows scale and glow
5. [ ] Click copies path to clipboard
6. [ ] Toast "Copie !" appears after copy
7. [ ] Citations work during streaming
8. [ ] Multiple citations in same response work
9. [ ] Line number displays when present
10. [ ] Keyboard focus ring visible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 0.1 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No significant debugging required

### Completion Notes List
- Created `lib/utils/file-extensions.ts` with color mapping for 15+ file extensions
- Created `lib/utils/citation-parser.ts` with regex parsing for `[path:line]` format
- Created `components/chat/CodeCitation.tsx` with full UX spec implementation
- Updated `components/chat/ChatMessage.tsx` with `ContentWithCitations` component
- Updated `components/chat/index.ts` to export CodeCitation
- Used sonner for toast notifications (already configured in project)
- Task 5 (tooltip preview) deferred to post-MVP
- All 54 new tests pass across 3 test files
- Build passes successfully

### File List
**New Files:**
- `lib/utils/file-extensions.ts` - Extension to color mapping utility
- `lib/utils/file-extensions.test.ts` - 16 tests
- `lib/utils/citation-parser.ts` - Citation regex parser
- `lib/utils/citation-parser.test.ts` - 18 tests
- `components/chat/CodeCitation.tsx` - Citation pill component
- `components/chat/CodeCitation.test.tsx` - 20 tests

**Modified Files:**
- `components/chat/ChatMessage.tsx` - Added ContentWithCitations renderer
- `components/chat/index.ts` - Added CodeCitation export

## QA Results
_To be filled by QA Agent_
