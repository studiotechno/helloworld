# Story 3.1: Interface Chat de Base

## Status

Done

## Story

**As a** utilisateur avec un repo connecte,
**I want** voir une interface de chat claire et moderne,
**So that** je puisse interagir naturellement avec mon code.

## Acceptance Criteria

1. **Given** j'ai un repository connecte, **When** j'accede a l'interface de chat, **Then** je vois un conteneur de chat centre (max 800px)
2. **And** un champ de saisie en bas avec placeholder "Posez une question sur votre code..."
3. **And** le champ s'agrandit automatiquement (auto-resize jusqu'a 200px max)
4. **And** je peux envoyer avec Cmd+Enter ou le bouton d'envoi
5. **And** le design "Fun & Vibrant" est applique (dark mode, accents roses)
6. **Given** aucune conversation n'existe, **When** j'arrive sur le chat, **Then** un EmptyState s'affiche avec titre en gradient
7. **And** des SuggestionChips proposent des questions de depart
8. **And** l'icone a un effet glow pulse

## Tasks / Subtasks

- [ ] Task 1: Create Chat Page Route (AC: 1)
  - [ ] Create `app/(dashboard)/chat/page.tsx` as main chat entry point
  - [ ] Create `app/(dashboard)/chat/[conversationId]/page.tsx` for specific conversations
  - [ ] Add route protection (redirect to /repos if no active repo)
  - [ ] Use DashboardShell layout

- [ ] Task 2: Create ChatContainer Component (AC: 1, 5)
  - [ ] Create `components/chat/ChatContainer.tsx`
  - [ ] Implement centered container with max-width 800px
  - [ ] Add generous padding (48px sides) per UX spec
  - [ ] Apply dark mode styling with rose accents
  - [ ] Include scroll area for messages

- [ ] Task 3: Create ChatInput Component (AC: 2, 3, 4)
  - [ ] Create `components/chat/ChatInput.tsx`
  - [ ] Implement textarea with placeholder "Posez une question sur votre code..."
  - [ ] Add auto-resize functionality (min 56px, max 200px)
  - [ ] Add send button with rose glow effect
  - [ ] Implement Cmd+Enter keyboard shortcut
  - [ ] Style with border-radius 24px and glow on focus
  - [ ] Disable send when input is empty

- [ ] Task 4: Create EmptyState Component (AC: 6, 8)
  - [ ] Create `components/chat/EmptyState.tsx`
  - [ ] Add main icon with pulsed glow effect
  - [ ] Create title with gradient text (rose to pink)
  - [ ] Add description text
  - [ ] Implement fade-in staggered animation

- [ ] Task 5: Create SuggestionChips Component (AC: 7)
  - [ ] Create `components/chat/SuggestionChips.tsx`
  - [ ] Display array of suggested questions with emoji
  - [ ] Style as pills with border and rose hover effect
  - [ ] Add hover animation (translateY -2px + glow)
  - [ ] Handle click to fill input field
  - [ ] Include suggestions: "C'est quoi la stack technique?", "Quelles sont les features principales?", "Montre-moi le schema de la BDD"

- [ ] Task 6: Update Chat Index Exports
  - [ ] Update `components/chat/index.ts` with new exports
  - [ ] Export ChatContainer, ChatInput, EmptyState, SuggestionChips

- [ ] Task 7: Unit Tests
  - [ ] Test ChatContainer rendering
  - [ ] Test ChatInput auto-resize and keyboard shortcuts
  - [ ] Test EmptyState display
  - [ ] Test SuggestionChips click handler

## Dev Notes

### Previous Story Context (2.4)

Story 2.4 implemented repository disconnection:
- DisconnectRepoDialog component
- useDisconnectRepo hook
- Settings page integration

**Key files from Epic 2:**
- `hooks/useActiveRepo.ts` - Fetches active repository (use to check if repo connected)
- `components/repos/RepoSelector.tsx` - Shows active repo in TopBar
- `components/layout/DashboardShell.tsx` - Dashboard layout wrapper

### Existing Chat Scaffold

The chat component folder already exists with placeholder exports:
- `components/chat/index.ts` - Ready for exports

### Chat Page Route Structure

```
app/
‚îú‚îÄ‚îÄ (dashboard)/
‚îÇ   ‚îî‚îÄ‚îÄ chat/
‚îÇ       ‚îú‚îÄ‚îÄ page.tsx              # NEW: Main chat entry (empty state)
‚îÇ       ‚îî‚îÄ‚îÄ [conversationId]/
‚îÇ           ‚îî‚îÄ‚îÄ page.tsx          # NEW: Specific conversation view
```

### ChatContainer Component Pattern

```tsx
// components/chat/ChatContainer.tsx
'use client'

import { ReactNode } from 'react'
import { cn } from '@/lib/utils'

interface ChatContainerProps {
  children: ReactNode
  className?: string
}

export function ChatContainer({ children, className }: ChatContainerProps) {
  return (
    <div
      className={cn(
        'mx-auto flex h-full max-w-[800px] flex-col px-4 md:px-12',
        className
      )}
    >
      {children}
    </div>
  )
}
```

### ChatInput Component Pattern

```tsx
// components/chat/ChatInput.tsx
'use client'

import { useRef, useState, useCallback, KeyboardEvent, ChangeEvent } from 'react'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { Send } from 'lucide-react'
import { cn } from '@/lib/utils'

interface ChatInputProps {
  onSend: (message: string) => void
  disabled?: boolean
  placeholder?: string
}

export function ChatInput({
  onSend,
  disabled = false,
  placeholder = "Posez une question sur votre code..."
}: ChatInputProps) {
  const [value, setValue] = useState('')
  const textareaRef = useRef<HTMLTextAreaElement>(null)

  const handleSubmit = useCallback(() => {
    const trimmed = value.trim()
    if (trimmed && !disabled) {
      onSend(trimmed)
      setValue('')
      // Reset textarea height
      if (textareaRef.current) {
        textareaRef.current.style.height = 'auto'
      }
    }
  }, [value, disabled, onSend])

  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
      e.preventDefault()
      handleSubmit()
    }
  }

  const handleChange = (e: ChangeEvent<HTMLTextAreaElement>) => {
    setValue(e.target.value)
    // Auto-resize
    const textarea = e.target
    textarea.style.height = 'auto'
    textarea.style.height = `${Math.min(textarea.scrollHeight, 200)}px`
  }

  return (
    <div className="relative flex items-end gap-2 border-t border-border/50 bg-background/80 p-4 backdrop-blur-sm">
      <Textarea
        ref={textareaRef}
        value={value}
        onChange={handleChange}
        onKeyDown={handleKeyDown}
        placeholder={placeholder}
        disabled={disabled}
        className={cn(
          'min-h-[56px] max-h-[200px] resize-none rounded-3xl border-2 border-border/50',
          'px-6 py-4 text-base',
          'focus:border-primary focus:ring-2 focus:ring-primary/20',
          'transition-all duration-200'
        )}
        rows={1}
      />
      <Button
        onClick={handleSubmit}
        disabled={disabled || !value.trim()}
        size="icon"
        className={cn(
          'size-12 shrink-0 rounded-full',
          'bg-primary hover:bg-primary/90',
          'shadow-lg shadow-primary/25',
          'transition-all duration-200'
        )}
      >
        <Send className="size-5" />
        <span className="sr-only">Envoyer</span>
      </Button>
    </div>
  )
}
```

### EmptyState Component Pattern

```tsx
// components/chat/EmptyState.tsx
'use client'

import { MessageSquare } from 'lucide-react'
import { SuggestionChips } from './SuggestionChips'
import { cn } from '@/lib/utils'

interface EmptyStateProps {
  onSuggestionClick?: (suggestion: string) => void
}

const suggestions = [
  { emoji: 'üîß', text: "C'est quoi la stack technique?" },
  { emoji: 'üéØ', text: 'Quelles sont les features principales?' },
  { emoji: 'üóÑÔ∏è', text: 'Montre-moi le schema de la BDD' },
  { emoji: 'üìÅ', text: 'Comment est structure le projet?' },
]

export function EmptyState({ onSuggestionClick }: EmptyStateProps) {
  return (
    <div className="flex flex-1 flex-col items-center justify-center gap-8 px-4">
      {/* Icon with glow */}
      <div className="relative">
        <div className="absolute inset-0 animate-pulse rounded-full bg-primary/20 blur-xl" />
        <div className="relative rounded-2xl bg-primary/10 p-6">
          <MessageSquare className="size-12 text-primary" />
        </div>
      </div>

      {/* Gradient title */}
      <div className="space-y-2 text-center">
        <h2
          className={cn(
            'text-2xl font-bold',
            'bg-gradient-to-r from-primary via-pink-400 to-primary bg-clip-text text-transparent'
          )}
        >
          Posez votre premiere question
        </h2>
        <p className="max-w-md text-muted-foreground">
          Interrogez votre codebase en langage naturel. Je suis la pour vous aider
          a comprendre votre code.
        </p>
      </div>

      {/* Suggestion chips */}
      <SuggestionChips
        suggestions={suggestions}
        onSelect={onSuggestionClick}
      />
    </div>
  )
}
```

### SuggestionChips Component Pattern

```tsx
// components/chat/SuggestionChips.tsx
'use client'

import { cn } from '@/lib/utils'

interface Suggestion {
  emoji: string
  text: string
}

interface SuggestionChipsProps {
  suggestions: Suggestion[]
  onSelect?: (text: string) => void
  className?: string
}

export function SuggestionChips({
  suggestions,
  onSelect,
  className
}: SuggestionChipsProps) {
  return (
    <div className={cn('flex flex-wrap justify-center gap-3', className)}>
      {suggestions.map((suggestion, index) => (
        <button
          key={index}
          onClick={() => onSelect?.(suggestion.text)}
          className={cn(
            'flex items-center gap-2 rounded-full px-4 py-2',
            'border border-border/50 bg-secondary/50',
            'text-sm text-muted-foreground',
            'transition-all duration-200',
            'hover:-translate-y-0.5 hover:border-primary/50 hover:text-foreground',
            'hover:shadow-md hover:shadow-primary/10',
            'focus:outline-none focus:ring-2 focus:ring-primary/50'
          )}
        >
          <span>{suggestion.emoji}</span>
          <span>{suggestion.text}</span>
        </button>
      ))}
    </div>
  )
}
```

### Chat Page Pattern

```tsx
// app/(dashboard)/chat/page.tsx
'use client'

import { useRouter } from 'next/navigation'
import { useActiveRepo } from '@/hooks'
import { ChatContainer, ChatInput, EmptyState } from '@/components/chat'
import { useEffect, useCallback, useState } from 'react'

export default function ChatPage() {
  const router = useRouter()
  const { data: activeRepo, isLoading } = useActiveRepo()
  const [inputValue, setInputValue] = useState('')

  // Redirect to repos if no active repo
  useEffect(() => {
    if (!isLoading && !activeRepo) {
      router.push('/repos')
    }
  }, [activeRepo, isLoading, router])

  const handleSuggestionClick = useCallback((suggestion: string) => {
    setInputValue(suggestion)
  }, [])

  const handleSend = useCallback((message: string) => {
    // Will be implemented in Story 3.2
    console.log('Sending message:', message)
  }, [])

  if (isLoading) {
    return (
      <ChatContainer>
        <div className="flex flex-1 items-center justify-center">
          <div className="size-8 animate-spin rounded-full border-4 border-primary border-t-transparent" />
        </div>
      </ChatContainer>
    )
  }

  return (
    <ChatContainer>
      <EmptyState onSuggestionClick={handleSuggestionClick} />
      <ChatInput
        onSend={handleSend}
        defaultValue={inputValue}
      />
    </ChatContainer>
  )
}
```

### Design Tokens (UX Reference)

From the UX specification "Fun & Vibrant" direction:

| Element | Specification |
|---------|---------------|
| Background primary | #09090B (dark) |
| Accent color | #EC4899 (rose) |
| Border radius input | 24px |
| Chat max-width | 800px |
| Padding chat area | 48px |
| Input min-height | 56px |
| Input max-height | 200px |
| Suggestion hover | translateY(-2px) + glow |

### Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| Cmd+Enter / Ctrl+Enter | Send message |
| (Future) Cmd+N | New conversation |

### Accessibility Requirements

- Focus visible ring on all interactive elements
- Keyboard navigation for suggestions
- `aria-label` on send button
- `role="status"` for loading states
- Touch targets minimum 44x44px

## Testing

### Test File Locations

- `components/chat/ChatContainer.test.tsx`
- `components/chat/ChatInput.test.tsx`
- `components/chat/EmptyState.test.tsx`
- `components/chat/SuggestionChips.test.tsx`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Test both rendering and interactions

### Testing Requirements

**Unit Tests:**
- ChatContainer: renders children, applies max-width
- ChatInput: auto-resize, keyboard shortcut, disabled state
- EmptyState: renders with gradient title, glow icon
- SuggestionChips: click handler, hover states

**Manual Testing Checklist:**
1. Navigate to /chat with connected repo -> see EmptyState
2. Navigate to /chat without repo -> redirect to /repos
3. Type in input -> see auto-resize up to 200px
4. Press Cmd+Enter -> trigger send (logged)
5. Click suggestion chip -> fills input field
6. Verify gradient title and glow effect on icon
7. Verify rose accent colors applied
8. Test on mobile viewport -> responsive layout

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- Fixed lint error: ChatInput was using `useEffect` with `setState` (refactored to controlled component pattern)

### Completion Notes List
- Created ChatContainer component with max-width 800px and flex column layout
- Created ChatInput as controlled component with `value`/`onChange` props
- ChatInput supports Cmd+Enter / Ctrl+Enter to send
- ChatInput has auto-resize up to 200px max height
- Created EmptyState with gradient title and pulsed glow effect on icon
- Created SuggestionChips with hover animations (translateY + glow)
- Chat pages redirect to /repos if no active repo connected
- Added CSS animation for gradient title (`animate-gradient`)

### File List
- `components/chat/ChatContainer.tsx` - NEW
- `components/chat/ChatInput.tsx` - NEW
- `components/chat/EmptyState.tsx` - NEW
- `components/chat/SuggestionChips.tsx` - NEW
- `components/chat/index.ts` - UPDATED (exports)
- `components/chat/ChatContainer.test.tsx` - NEW (4 tests)
- `components/chat/ChatInput.test.tsx` - NEW (14 tests)
- `components/chat/EmptyState.test.tsx` - NEW (6 tests)
- `components/chat/SuggestionChips.test.tsx` - NEW (8 tests)
- `app/(dashboard)/chat/page.tsx` - NEW
- `app/(dashboard)/chat/[conversationId]/page.tsx` - NEW
- `app/globals.css` - UPDATED (gradient animation)

## QA Results
_To be filled by QA Agent_
