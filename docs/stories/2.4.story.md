# Story 2.4: Deconnexion d'un Repository

## Status

Done

## Story

**As a** utilisateur,
**I want** deconnecter un repository de mon compte,
**So that** je puisse revoquer l'acces si necessaire.

## Acceptance Criteria

1. **Given** j'ai un repository connecte, **When** je vais dans les parametres, **Then** je vois une section "Repository connecte" avec les infos du repo actif
2. **And** je vois un bouton "Deconnecter le repository"
3. **Given** je clique sur "Deconnecter le repository", **When** le dialog s'ouvre, **Then** une confirmation est demandee
4. **Given** je confirme la deconnexion, **When** je valide, **Then** le repository est supprime de ma base de donnees
5. **And** je suis redirige vers la page de selection de repository (/repos)
6. **And** un toast confirme "Repository deconnecte"
7. **And** mes conversations passees restent accessibles en lecture seule (a implementer dans Epic 3)

## Tasks / Subtasks

- [ ] Task 1: Create Disconnect Repository API Route (AC: 4)
  - [ ] Create `app/api/repos/disconnect/route.ts` with POST handler
  - [ ] Authenticate user via `getCurrentUser()`
  - [ ] Find and delete user's active repository from database
  - [ ] Return success response
  - [ ] Handle errors (no repo connected, etc.)

- [ ] Task 2: Create DisconnectRepoDialog Component (AC: 3)
  - [ ] Create `components/repos/DisconnectRepoDialog.tsx`
  - [ ] Display repository name in warning message
  - [ ] Add "Deconnecter" and "Annuler" buttons
  - [ ] Show loading state during API call
  - [ ] Style with destructive theme (similar to DeleteAccountDialog)

- [ ] Task 3: Create useDisconnectRepo Hook (AC: 4)
  - [ ] Create `hooks/useDisconnectRepo.ts` with React Query mutation
  - [ ] Configure mutation key: `['repos', 'disconnect']`
  - [ ] Invalidate `activeRepo` and `repos` queries on success
  - [ ] Handle loading, success, and error states

- [ ] Task 4: Add Repository Section to Settings Page (AC: 1, 2, 5, 6)
  - [ ] Update `app/(dashboard)/settings/page.tsx`
  - [ ] Add "Repository connecte" Card showing active repo info
  - [ ] Display repo full_name, branch, and technologies
  - [ ] Add "Deconnecter" button opening DisconnectRepoDialog
  - [ ] Show toast "Repository deconnecte" on success
  - [ ] Navigate to `/repos` after successful disconnect
  - [ ] Handle "no repo connected" state gracefully

- [ ] Task 5: Unit Tests
  - [ ] Test DisconnectRepoDialog component rendering
  - [ ] Test useDisconnectRepo hook
  - [ ] Test API route with mocked Prisma
  - [ ] Test settings page repository section

## Dev Notes

### Previous Story Context (2.3)

Story 2.3 implemented repository display in header:
- `RepoSelector` component shows active repo in TopBar
- `TechTags` component displays detected technologies
- `useRepoTechnologies` hook fetches languages from GitHub API
- API `/api/repos/technologies` for fetching repo languages

**Key files from previous stories:**
- `hooks/useActiveRepo.ts` - Fetches active repository
- `hooks/useConnectRepo.ts` - Connects repository
- `app/api/repos/active/route.ts` - GET active repo API
- `app/api/repos/connect/route.ts` - POST connect repo API
- `lib/auth/sync-user.ts` - `getCurrentUser()` helper

### Existing Settings Page

[Source: app/(dashboard)/settings/page.tsx]

The settings page already has:
- Profile Card with user info
- Danger Zone Card with DeleteAccountDialog
- Pattern for confirmation dialogs

We need to add a "Repository connecte" section between Profile and Danger Zone.

### Disconnect Repository API Pattern

```typescript
// app/api/repos/disconnect/route.ts
import { NextResponse } from 'next/server'
import { prisma } from '@/lib/db/prisma'
import { getCurrentUser } from '@/lib/auth/sync-user'

export async function POST() {
  const user = await getCurrentUser()

  if (!user) {
    return NextResponse.json(
      { error: { code: 'UNAUTHORIZED', message: 'Non authentifie' } },
      { status: 401 }
    )
  }

  // Delete all user's repositories (MVP = 1 repo)
  const deleted = await prisma.repositories.deleteMany({
    where: {
      user_id: user.id,
      is_active: true,
    },
  })

  if (deleted.count === 0) {
    return NextResponse.json(
      { error: { code: 'NO_REPO', message: 'Aucun repository connecte' } },
      { status: 404 }
    )
  }

  return NextResponse.json({ success: true })
}
```

### useDisconnectRepo Hook Pattern

```typescript
// hooks/useDisconnectRepo.ts
import { useMutation, useQueryClient } from '@tanstack/react-query'

async function disconnectRepo() {
  const res = await fetch('/api/repos/disconnect', {
    method: 'POST',
  })
  if (!res.ok) {
    const error = await res.json()
    throw new Error(error.error?.message || 'Failed to disconnect repo')
  }
  return res.json()
}

export function useDisconnectRepo() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: disconnectRepo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['repos'] })
      queryClient.invalidateQueries({ queryKey: ['activeRepo'] })
      queryClient.invalidateQueries({ queryKey: ['repoTechnologies'] })
    },
  })
}
```

### DisconnectRepoDialog Pattern

Similar to DeleteAccountDialog but simpler (no confirmation text input required):

```tsx
// components/repos/DisconnectRepoDialog.tsx
<AlertDialog>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Deconnecter le repository ?</AlertDialogTitle>
      <AlertDialogDescription>
        Vous allez deconnecter <strong>{repoName}</strong>.
        Vos conversations passees resteront accessibles.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Annuler</AlertDialogCancel>
      <AlertDialogAction onClick={onConfirm} disabled={isLoading}>
        {isLoading ? 'Deconnexion...' : 'Deconnecter'}
      </AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

### Project Structure for This Story

```
app/
├── api/
│   └── repos/
│       └── disconnect/
│           └── route.ts      # NEW: POST disconnect repo
├── (dashboard)/
│   └── settings/
│       └── page.tsx          # UPDATE: Add repo section

components/
├── repos/
│   ├── DisconnectRepoDialog.tsx      # NEW: Disconnect confirmation dialog
│   └── DisconnectRepoDialog.test.tsx # NEW: Dialog tests

hooks/
├── useDisconnectRepo.ts      # NEW: Disconnect mutation hook
├── useDisconnectRepo.test.tsx # NEW: Hook tests
└── index.ts                  # UPDATE: Export new hook
```

### Database Considerations

- `deleteMany` is used to handle edge cases where multiple repos might exist
- Conversations table has `repository_id` foreign key - they are NOT deleted
- Epic 3 will handle displaying conversations in read-only mode for disconnected repos

### UX Considerations

- The dialog is simpler than delete account (no confirmation text required)
- User sees repo info before disconnecting (prevents accidental disconnection)
- Redirect to /repos encourages reconnecting a repo

## Testing

### Test File Locations

- `app/api/repos/disconnect/route.test.ts`
- `components/repos/DisconnectRepoDialog.test.tsx`
- `hooks/useDisconnectRepo.test.tsx`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Mock Prisma client for database operations
- Test both success and error paths

### Testing Requirements

**Unit Tests:**
- API route: disconnect repo, no repo connected error, unauthorized
- Dialog: render, button clicks, loading state
- Hook: loading state, success callback, error handling

**Manual Testing Checklist:**
1. Navigate to /settings with connected repo
2. Verify repository section shows active repo info
3. Click "Deconnecter le repository"
4. Verify dialog opens with repo name
5. Click "Annuler" -> verify dialog closes
6. Click "Deconnecter" -> verify loading state
7. Verify toast "Repository deconnecte" appears
8. Verify redirect to /repos
9. Verify RepoSelector shows "Selectionnez un repository"
10. Test with no repo connected -> section should be hidden or show "Aucun repository"

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

## QA Results
_To be filled by QA Agent_
