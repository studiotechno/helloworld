# Story 3.5: Liste des Conversations dans la Sidebar

## Status

Ready for Review

## Story

**As a** utilisateur,
**I want** voir la liste de mes conversations passees dans la sidebar,
**So that** je puisse naviguer entre mes differentes sessions de questions.

## Acceptance Criteria

1. **Given** j'ai plusieurs conversations, **When** je regarde la sidebar, **Then** les conversations sont listees avec leur titre et un emoji
2. **And** elles sont groupees par date (Aujourd'hui, Hier, Cette semaine, etc.)
3. **And** la conversation active est mise en evidence
4. **Given** je clique sur une conversation dans la liste, **When** je la selectionne, **Then** le chat affiche l'historique de cette conversation
5. **And** je peux continuer a poser des questions
6. **Given** je survole une conversation, **When** le hover est actif, **Then** un bouton de suppression apparait
7. **And** je peux supprimer la conversation avec confirmation

## Tasks / Subtasks

- [x] Task 1: Create Date Grouping Utility (AC: 2)
  - [x] Create `lib/utils/date-groups.ts` with grouping logic
  - [x] Implement date categorization: Aujourd'hui, Hier, Cette semaine, Ce mois, Plus ancien
  - [x] Use `created_at` or `updated_at` for grouping
  - [x] Write unit tests for date grouping logic

- [x] Task 2: Create ConversationItem Component (AC: 1, 3, 6, 7)
  - [x] Create `components/layout/ConversationItem.tsx`
  - [x] Display title with truncation
  - [x] Add emoji prefix based on first message content or conversation type
  - [x] Highlight active conversation (based on current URL)
  - [x] Show delete button on hover
  - [x] Add tooltip for full title on truncation

- [x] Task 3: Create DeleteConversationDialog Component (AC: 7)
  - [x] Create `components/layout/DeleteConversationDialog.tsx`
  - [x] Follow existing AlertDialog pattern from `DisconnectRepoDialog.tsx`
  - [x] Confirmation text: "Supprimer cette conversation ?"
  - [x] Show conversation title in dialog

- [x] Task 4: Create Delete Conversation API (AC: 7)
  - [x] Create `app/api/conversations/[conversationId]/route.ts` with DELETE method
  - [x] Verify ownership before deletion
  - [x] Cascade delete messages
  - [x] Return 204 on success

- [x] Task 5: Add useDeleteConversation Hook (AC: 7)
  - [x] Add mutation to `hooks/use-conversations.ts`
  - [x] Invalidate conversations query on success
  - [x] Handle optimistic update for smooth UX

- [x] Task 6: Update Sidebar with Grouped Conversations (AC: 1, 2, 3)
  - [x] Update `components/layout/Sidebar.tsx`
  - [x] Group conversations by date using date-groups utility
  - [x] Render section headers (Aujourd'hui, Hier, etc.)
  - [x] Use new ConversationItem component
  - [x] Maintain collapsed state behavior

- [x] Task 7: Unit Tests (AC: 1, 2, 3, 6, 7)
  - [x] Test date grouping utility
  - [x] Test ConversationItem component
  - [x] Test DeleteConversationDialog component
  - [x] Test Sidebar with grouped conversations

## Dev Notes

### Previous Story Context (3.4)

Story 3.4 implemented:
- `hooks/use-keyboard-shortcuts.ts` - Keyboard shortcut hook for ‚åò+N
- Updated Sidebar tooltip to show (‚åò+N) hint
- Verified EmptyState and suggestion flow

Key files from Story 3.4:
- `hooks/use-keyboard-shortcuts.ts` - Global keyboard shortcut handling
- `components/layout/Sidebar.tsx` - Updated tooltip

### Existing Implementation Analysis

**Current Sidebar Implementation** - `components/layout/Sidebar.tsx`:
- Already fetches conversations using `useConversations()` hook
- Displays flat list without date grouping
- Shows title and MessageSquare icon
- Highlights active conversation based on pathname
- No delete functionality
- No emoji prefix

**Current Conversation Interface** - `hooks/use-conversations.ts:3-16`:
```typescript
export interface Conversation {
  id: string
  user_id: string
  repository_id: string
  title: string | null
  created_at: string
  updated_at: string
  repository: {
    full_name: string
  }
  _count: {
    messages: number
  }
}
```

**Existing AlertDialog Pattern** - `components/repos/DisconnectRepoDialog.tsx`:
- Uses AlertDialog from shadcn/ui
- Loading state during async operation
- Toast notifications for success/error
- Prevents closing during operation

### Date Grouping Requirements [Source: epics.md#story-3.5]

Groups:
1. **Aujourd'hui** - Conversations from today
2. **Hier** - Conversations from yesterday
3. **Cette semaine** - This week (excluding today/yesterday)
4. **Ce mois** - This month (excluding this week)
5. **Plus ancien** - Older conversations

Implementation approach:
```typescript
// lib/utils/date-groups.ts
export type DateGroup = 'today' | 'yesterday' | 'thisWeek' | 'thisMonth' | 'older'

export const DATE_GROUP_LABELS: Record<DateGroup, string> = {
  today: "Aujourd'hui",
  yesterday: 'Hier',
  thisWeek: 'Cette semaine',
  thisMonth: 'Ce mois',
  older: 'Plus ancien',
}

export function getDateGroup(date: Date | string): DateGroup {
  const d = new Date(date)
  const now = new Date()
  // ... comparison logic
}

export function groupConversationsByDate<T extends { updated_at: string }>(
  conversations: T[]
): Map<DateGroup, T[]> {
  // Group and maintain order
}
```

### Emoji Generation for Conversations

Based on UX spec examples, emojis are content-aware:
- Tech analysis could use relevant emoji
- Default fallback emoji options

Simple approach for MVP:
```typescript
function getConversationEmoji(title: string | null): string {
  // Simple keyword matching for MVP
  const titleLower = (title || '').toLowerCase()
  if (titleLower.includes('bug') || titleLower.includes('error')) return 'üêõ'
  if (titleLower.includes('test')) return 'üß™'
  if (titleLower.includes('database') || titleLower.includes('db')) return 'üóÑÔ∏è'
  if (titleLower.includes('api')) return 'üîå'
  if (titleLower.includes('security')) return 'üîí'
  if (titleLower.includes('performance')) return '‚ö°'
  // Default
  return 'üí¨'
}
```

### Component Structure [Source: architecture.md#component-architecture]

```
components/
‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îú‚îÄ‚îÄ Sidebar.tsx              # UPDATE: Use grouped conversations
‚îÇ   ‚îú‚îÄ‚îÄ ConversationItem.tsx     # NEW: Single conversation item
‚îÇ   ‚îî‚îÄ‚îÄ DeleteConversationDialog.tsx  # NEW: Confirmation dialog
‚îÇ
lib/
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ date-groups.ts           # NEW: Date grouping utility
‚îÇ
hooks/
‚îî‚îÄ‚îÄ use-conversations.ts         # UPDATE: Add useDeleteConversation
‚îÇ
app/
‚îî‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ conversations/
        ‚îî‚îÄ‚îÄ [conversationId]/
            ‚îî‚îÄ‚îÄ route.ts         # UPDATE: Add DELETE method
```

### Delete API Implementation

```typescript
// app/api/conversations/[conversationId]/route.ts
export async function DELETE(
  req: Request,
  { params }: { params: Promise<{ conversationId: string }> }
) {
  const user = await getCurrentUser()
  if (!user) return 401

  const { conversationId } = await params

  // Verify ownership
  const conversation = await prisma.conversations.findFirst({
    where: { id: conversationId, user_id: user.id }
  })

  if (!conversation) return 404

  // Delete (messages cascade automatically)
  await prisma.conversations.delete({
    where: { id: conversationId }
  })

  return 204
}
```

### Testing Requirements [Source: architecture.md#testing]

**Unit Tests:**
- `lib/utils/date-groups.test.ts`
  - Test each date group categorization
  - Test grouping function maintains order
  - Test edge cases (midnight, timezone)

- `components/layout/ConversationItem.test.tsx`
  - Test render with title
  - Test active state highlighting
  - Test hover shows delete button
  - Test click navigation

- `components/layout/DeleteConversationDialog.test.tsx`
  - Test confirmation flow
  - Test loading state
  - Test cancel behavior

**Test Framework:** Vitest + Testing Library

### Technical Constraints

1. **Date Handling**: Use `date-fns` if available, otherwise native Date API
2. **Timezone**: Use user's local timezone for grouping
3. **Performance**: Memoize grouped conversations to avoid re-computation
4. **Accessibility**: Delete button must be keyboard accessible

## Testing

### Test File Locations

- `lib/utils/date-groups.test.ts`
- `components/layout/ConversationItem.test.tsx`
- `components/layout/DeleteConversationDialog.test.tsx`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Mock `useRouter` for navigation tests
- Mock `fetch` for API tests

### Manual Testing Checklist

1. [ ] Conversations grouped by date correctly
2. [ ] Group headers display in French (Aujourd'hui, Hier, etc.)
3. [ ] Active conversation highlighted
4. [ ] Hover on conversation shows delete button
5. [ ] Delete button click opens confirmation dialog
6. [ ] Confirm delete removes conversation
7. [ ] Cancel close dialog without action
8. [ ] Toast notification on successful delete
9. [ ] Conversation list updates after delete
10. [ ] Collapsed sidebar still works correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 0.1 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No significant debugging required

### Completion Notes List
- Created date grouping utility with proper calendar day handling (not just hour-based)
- Implemented emoji generation based on conversation title keywords
- Created ConversationItem component with hover delete functionality
- Created DeleteConversationDialog following existing AlertDialog patterns
- Added DELETE endpoint for conversations with ownership verification
- Added useDeleteConversation hook with optimistic updates
- Updated Sidebar to group conversations by date with French labels
- All tests pass (259/260 - 1 pre-existing failure in DeleteAccountDialog unrelated to this story)
- Lint passes with no errors or warnings

### File List
**New Files:**
- `lib/utils/date-groups.ts` - Date grouping utility
- `lib/utils/date-groups.test.ts` - Date grouping tests
- `components/layout/ConversationItem.tsx` - Conversation item component
- `components/layout/ConversationItem.test.tsx` - ConversationItem tests
- `components/layout/DeleteConversationDialog.tsx` - Delete confirmation dialog
- `components/layout/DeleteConversationDialog.test.tsx` - DeleteConversationDialog tests
- `app/api/conversations/[conversationId]/route.ts` - DELETE API endpoint

**Modified Files:**
- `components/layout/Sidebar.tsx` - Updated to use grouped conversations
- `components/layout/Sidebar.test.tsx` - Updated tests for new imports
- `components/layout/index.ts` - Added new component exports
- `hooks/use-conversations.ts` - Added useDeleteConversation hook
- `hooks/index.ts` - Added useDeleteConversation export

## QA Results
_To be filled by QA Agent_
