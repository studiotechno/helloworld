# Story 2.1: Integration GitHub API & Liste des Repositories

## Status

Done

## Story

**As a** utilisateur connecte,
**I want** voir la liste de mes repositories GitHub accessibles,
**So that** je puisse choisir celui que je veux analyser.

## Acceptance Criteria

1. **Given** je suis connecte avec GitHub OAuth, **When** j'accede a la page de selection de repository, **Then** la liste de mes repositories GitHub s'affiche
2. **And** chaque repo montre : nom, description, langage principal, derniere mise a jour
3. **And** je peux rechercher/filtrer dans la liste
4. **And** les repos sont tries par derniere activite
5. **Given** j'ai deja charge la liste recemment (< 5 min), **When** je recharge la page, **Then** la liste est servie depuis le cache Vercel KV
6. **And** aucun appel GitHub API n'est effectue
7. **Given** l'API GitHub est indisponible, **When** je tente de charger la liste, **Then** un message d'erreur explicatif s'affiche
8. **And** je peux reessayer

## Tasks / Subtasks

- [x] Task 1: Install Octokit and Configure GitHub Client (AC: 1)
  - [x] Install Octokit: `npm install octokit`
  - [x] Update `lib/github/client.ts` with actual Octokit implementation
  - [x] Implement `createGitHubClient(accessToken)` function
  - [x] Implement `fetchUserRepos(accessToken)` to fetch user's repositories
  - [x] Handle GitHub API rate limits gracefully

- [x] Task 2: Setup Vercel KV Cache for GitHub API (AC: 5, 6)
  - [x] Install Vercel KV: `npm install @vercel/kv`
  - [x] Create `lib/github/cache.ts` with caching utilities
  - [x] Implement `getCachedRepos(userId)` function
  - [x] Implement `setCachedRepos(userId, repos)` with 5-minute TTL
  - [x] Add cache key pattern: `repos:${userId}`

- [x] Task 3: Create Repository List API Route (AC: 1, 4, 5, 6, 7, 8)
  - [x] Create `app/api/repos/route.ts` with GET handler
  - [x] Authenticate user via Supabase session
  - [x] Get GitHub token from `session.provider_token`
  - [x] Check cache first, return cached data if fresh
  - [x] Fetch from GitHub API if cache miss
  - [x] Sort repos by `pushed_at` (most recent first)
  - [x] Store response in cache
  - [x] Handle GitHub API errors with user-friendly messages
  - [x] Return proper error structure: `{ error: { code, message } }`

- [x] Task 4: Create Repository List Page (AC: 1, 2, 3, 4)
  - [x] Create `app/(dashboard)/repos/page.tsx`
  - [x] Use React Query to fetch repos from `/api/repos`
  - [x] Display loading state with Skeleton components
  - [x] Display each repo with: full_name, description, language, pushed_at
  - [x] Style with dark mode theme (Fun & Vibrant)

- [x] Task 5: Implement Search/Filter Functionality (AC: 3)
  - [x] Add search input field at top of list
  - [x] Filter repos by name and description (client-side)
  - [x] Debounce search input (300ms)
  - [x] Show "No results" state when filter returns empty

- [x] Task 6: Create useRepos Hook (AC: 1, 7, 8)
  - [x] Create `hooks/useRepos.ts` with React Query
  - [x] Configure query key: `['repos']`
  - [x] Configure staleTime: 5 minutes (match cache TTL)
  - [x] Handle error state with retry button
  - [x] Export hook for use in components

- [x] Task 7: Add Repository Card Component (AC: 2)
  - [x] Create `components/repos/RepoCard.tsx`
  - [x] Display repo icon (GitHub logo or folder)
  - [x] Display full_name with owner/repo format
  - [x] Display description (truncated if long)
  - [x] Display language with colored badge
  - [x] Display relative time for pushed_at
  - [x] Add hover state with subtle glow effect

- [x] Task 8: Error Handling UI (AC: 7, 8)
  - [x] Create error state component for API failures
  - [x] Display user-friendly error message
  - [x] Add "Reessayer" button to retry fetch
  - [x] Handle specific error codes (rate limit, auth expired, network)

- [x] Task 9: Unit Tests
  - [x] Test `lib/github/client.ts` functions (mock Octokit)
  - [x] Test `lib/github/cache.ts` functions (mock Vercel KV)
  - [x] Test `hooks/useRepos.ts` hook
  - [x] Test RepoCard component rendering
  - [x] Test search/filter functionality

## Dev Notes

### Previous Story Context (1.4)

Story 1.4 completed the Epic 1 authentication and account features:
- Settings page at `/settings` with account deletion
- Delete account API at `/api/account/delete`
- Middleware protects `/dashboard`, `/chat`, `/settings` routes
- UserMenu component with "Parametres" link
- Toast notifications via Sonner
- Dark mode with Fun & Vibrant theme (#EC4899)

**Key insight from Epic 1:** GitHub OAuth is handled by Supabase, and the GitHub access token is available via `session.provider_token` (not stored separately in the database).

### GitHub Token Access Pattern

[Source: architecture.md#Authentication & Security]

```typescript
// Access GitHub token from Supabase session
const supabase = await createClient()
const { data: { session } } = await supabase.auth.getSession()
const githubToken = session?.provider_token // Direct access!
```

**Important:** The `github_token` column in the users table is currently unused. Supabase stores the provider token in the session automatically.

### Database Schema (repositories table)

[Source: prisma/schema.prisma]

```prisma
model repositories {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String    @db.Uuid
  github_repo_id String
  full_name      String    // owner/repo format
  default_branch String    @default("main")
  is_active      Boolean   @default(true)
  last_synced_at DateTime? @db.Timestamptz(6)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)

  user          users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  conversations conversations[]

  @@unique([user_id, github_repo_id])
  @@map("repositories")
}
```

**Note:** This story focuses on LISTING repositories from GitHub API. The actual connection/storage to the database will be in Story 2.2.

### Existing GitHub Types

[Source: lib/github/types.ts]

```typescript
export interface GitHubRepo {
  id: number
  name: string
  full_name: string
  description: string | null
  private: boolean
  language: string | null
  default_branch: string
  updated_at: string
  pushed_at: string
  size: number
  stargazers_count: number
}

export interface GitHubRateLimit {
  limit: number
  remaining: number
  reset: number
  used: number
}
```

### API Route Pattern

[Source: architecture.md#API & Communication Patterns]

```typescript
// app/api/repos/route.ts
export async function GET(req: Request) {
  try {
    const supabase = await createClient()
    const { data: { session } } = await supabase.auth.getSession()

    if (!session?.provider_token) {
      return NextResponse.json(
        { error: { code: 'UNAUTHORIZED', message: 'Non authentifie' } },
        { status: 401 }
      )
    }

    // Check cache first
    const cached = await getCachedRepos(session.user.id)
    if (cached) {
      return NextResponse.json(cached)
    }

    // Fetch from GitHub
    const repos = await fetchUserRepos(session.provider_token)

    // Cache the result
    await setCachedRepos(session.user.id, repos)

    return NextResponse.json(repos)
  } catch (error) {
    console.error('[API] Repos error:', error)
    return NextResponse.json(
      { error: { code: 'FETCH_FAILED', message: 'Impossible de charger les repositories' } },
      { status: 500 }
    )
  }
}
```

### Vercel KV Cache Pattern

[Source: architecture.md#Core Architectural Decisions]

```typescript
// lib/github/cache.ts
import { kv } from '@vercel/kv'

const CACHE_TTL = 300 // 5 minutes in seconds

export async function getCachedRepos(userId: string): Promise<GitHubRepo[] | null> {
  const key = `repos:${userId}`
  return await kv.get<GitHubRepo[]>(key)
}

export async function setCachedRepos(userId: string, repos: GitHubRepo[]): Promise<void> {
  const key = `repos:${userId}`
  await kv.set(key, repos, { ex: CACHE_TTL })
}
```

**Environment Variables Required:**
- `KV_REST_API_URL` - Vercel KV REST API URL
- `KV_REST_API_TOKEN` - Vercel KV REST API token

### React Query Hook Pattern

[Source: architecture.md#Frontend Architecture]

```typescript
// hooks/useRepos.ts
import { useQuery } from '@tanstack/react-query'
import type { GitHubRepo } from '@/lib/github/types'

async function fetchRepos(): Promise<GitHubRepo[]> {
  const res = await fetch('/api/repos')
  if (!res.ok) {
    const error = await res.json()
    throw new Error(error.error?.message || 'Failed to fetch repos')
  }
  return res.json()
}

export function useRepos() {
  return useQuery({
    queryKey: ['repos'],
    queryFn: fetchRepos,
    staleTime: 5 * 60 * 1000, // 5 minutes (match cache TTL)
  })
}
```

### UX Design Requirements

[Source: ux-design-specification.md#RepoSelector]

**RepoSelector Component Anatomy:**
- GitHub icon
- Repo name (owner/name)
- Dropdown chevron
- Badge with branch

**States:**
- `default` - Repo displayed
- `hover` - Subtle background
- `open` - Dropdown with repo list
- `loading` - Skeleton during fetch

**Accessibility:**
- `role="combobox"` with `aria-expanded`
- Keyboard navigation in list

### Project Structure for This Story

```
app/
├── api/
│   └── repos/
│       └── route.ts          # GET: list repos

├── (dashboard)/
│   └── repos/
│       └── page.tsx          # Repository selection page

components/
├── repos/
│   ├── index.ts              # Barrel export
│   ├── RepoCard.tsx          # Individual repo card
│   ├── RepoCard.test.tsx     # Unit tests
│   ├── RepoList.tsx          # List container with search
│   └── RepoList.test.tsx     # Unit tests

hooks/
├── useRepos.ts               # React Query hook

lib/
├── github/
│   ├── client.ts             # UPDATE: Implement with Octokit
│   ├── cache.ts              # NEW: Vercel KV cache layer
│   └── types.ts              # EXISTS: GitHub types
```

### Naming Conventions Reminder

[Source: architecture.md#Naming Patterns]

- Component files: **PascalCase.tsx** (e.g., `RepoCard.tsx`)
- Utility files: **kebab-case.ts** (e.g., `cache.ts`)
- API routes: **kebab-case plural** (e.g., `/api/repos`)
- Functions: **camelCase** (e.g., `fetchUserRepos()`)
- Types/Interfaces: **PascalCase** (e.g., `GitHubRepo`)

### Error Codes Reference

| Code | HTTP Status | Message |
|------|-------------|---------|
| `UNAUTHORIZED` | 401 | Non authentifie |
| `GITHUB_RATE_LIMIT` | 429 | Limite d'API GitHub atteinte |
| `GITHUB_UNAVAILABLE` | 503 | Service GitHub indisponible |
| `FETCH_FAILED` | 500 | Impossible de charger les repositories |

## Testing

### Test File Locations

- `lib/github/client.test.ts` - GitHub client tests
- `lib/github/cache.test.ts` - Cache layer tests
- `components/repos/RepoCard.test.tsx` - Component tests
- `components/repos/RepoList.test.tsx` - Component tests
- `hooks/useRepos.test.ts` - Hook tests

### Test Standards

[Source: architecture.md#Project Structure]

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Mock external dependencies (Octokit, Vercel KV)
- Test both success and error paths

### Testing Requirements for This Story

**Unit Tests:**
- GitHub client: mock Octokit responses, test error handling
- Cache layer: mock Vercel KV, test TTL behavior
- RepoCard: renders all fields, handles missing description
- RepoList: search filtering, empty state, loading state
- useRepos hook: success, error, loading states

**Manual Testing Checklist:**
1. Navigate to `/repos` when authenticated
2. Verify loading skeleton appears
3. Verify repo list displays with correct data
4. Test search filter (type in search box)
5. Verify repos sorted by most recent activity
6. Refresh page within 5 min - should be fast (cached)
7. Disconnect internet - verify error message and retry button
8. Check mobile responsiveness

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Installed `octokit` package for GitHub API integration
- Installed `@vercel/kv` package for caching
- Implemented GitHub client with Octokit in `lib/github/client.ts`
- Created cache layer in `lib/github/cache.ts` with 5-min TTL
- Created API route `/api/repos` with authentication and error handling
- Created `useRepos` React Query hook with proper staleTime
- Created `RepoCard`, `RepoError`, `RepoList` components
- Created `/repos` page with search/filter functionality
- All 86 tests pass, lint clean, build successful
- Note: RepoSelector dropdown (mentioned in UX spec) will be in Story 2.2 when user can connect repos

### File List

**Created:**
- `app/api/repos/route.ts` - API route for listing repositories
- `app/(dashboard)/repos/page.tsx` - Repository selection page
- `components/repos/index.ts` - Barrel export
- `components/repos/RepoCard.tsx` - Repository card component
- `components/repos/RepoCard.test.tsx` - RepoCard tests
- `components/repos/RepoError.tsx` - Error state component
- `components/repos/RepoList.tsx` - List container with search
- `hooks/useRepos.ts` - React Query hook for repos
- `hooks/useRepos.test.tsx` - useRepos hook tests
- `lib/github/cache.ts` - Vercel KV cache layer
- `lib/github/cache.test.ts` - Cache layer tests
- `lib/github/client.test.ts` - GitHub client tests

**Modified:**
- `lib/github/client.ts` - Implemented with Octokit
- `hooks/index.ts` - Added useRepos export
- `package.json` - Added octokit, @vercel/kv dependencies

## QA Results
_To be filled by QA Agent_
