# Story 2.3: Affichage Repository Actif & Selecteur

## Status

Done

## Story

**As a** utilisateur avec un repo connecte,
**I want** voir clairement quel repository est actif et pouvoir en changer,
**So that** je sache toujours sur quel code je travaille.

## Acceptance Criteria

1. **Given** j'ai un repository connecte, **When** je suis sur le dashboard ou le chat, **Then** le RepoSelector dans le header affiche le repo actif (owner/name)
2. **And** un badge montre la branche par defaut
3. **And** des TechTags colores affichent les technologies detectees
4. **Given** je clique sur le RepoSelector, **When** le dropdown s'ouvre, **Then** je vois l'option de changer de repository
5. **And** je peux acceder directement a la liste des repos

## Tasks / Subtasks

- [x] Task 1: Create RepoSelector Component (AC: 1, 2, 4, 5)
  - [x] Create `components/layout/RepoSelector.tsx`
  - [x] Display GitHub icon + repo full_name (owner/name)
  - [x] Display badge with default_branch
  - [x] Add dropdown chevron icon
  - [x] Implement dropdown menu with:
    - [x] Current repo info
    - [x] "Changer de repository" option → navigate to /repos
  - [x] Style with dark mode theme (Fun & Vibrant)
  - [x] Add hover/focus states with pink glow

- [x] Task 2: Create TechTags Component (AC: 3)
  - [x] Create `components/layout/TechTags.tsx`
  - [x] Accept array of technology names
  - [x] Display colored badges per technology category
  - [x] Define color mapping (React=blue, Node=green, Python=yellow, etc.)
  - [x] Handle overflow with horizontal scroll or "+N more"

- [x] Task 3: Detect Repository Technologies (AC: 3)
  - [x] Add `fetchRepoLanguages()` function in `lib/github/client.ts`
  - [x] Analyze repo language field from GitHub API
  - [x] Create API route `/api/repos/technologies` to fetch languages
  - [x] Return sorted languages by bytes (most used first)

- [x] Task 4: Integrate RepoSelector in TopBar (AC: 1)
  - [x] Replace placeholder in `components/layout/TopBar.tsx`
  - [x] Pass active repo data from `useActiveRepo` hook
  - [x] Handle loading state (skeleton)
  - [x] Handle no repo connected state

- [x] Task 5: Create useRepoTechnologies Hook (AC: 3)
  - [x] Create `hooks/useRepoTechnologies.ts`
  - [x] Fetch technologies for active repository
  - [x] Cache with React Query (10 min staleTime)
  - [x] Return loading and error states

- [x] Task 6: Mobile Responsive Design (AC: 1, 4)
  - [x] Truncate long repo names with ellipsis (max-w-[180px] truncate)
  - [x] Hide TechTags on small screens (hidden lg:flex)

- [x] Task 7: Unit Tests
  - [x] Test RepoSelector component rendering
  - [x] Test TechTags component with various technologies
  - [x] Test dropdown behavior (aria attributes)
  - [x] Test technology detection function (fetchRepoLanguages)

## Dev Notes

### Previous Story Context (2.2)

Story 2.2 implemented repository connection:
- API `/api/repos/connect` for connecting repos
- API `/api/repos/active` for getting active repo
- `useConnectRepo` mutation hook
- `useActiveRepo` query hook
- `ActiveRepoContext` for app-wide state
- Size warning dialog for large repos (> 50MB)

**Key files from 2.2:**
- `hooks/useActiveRepo.ts` - Fetches active repository
- `hooks/useConnectRepo.ts` - Connects repository
- `contexts/ActiveRepoContext.tsx` - Active repo context
- `app/api/repos/active/route.ts` - GET active repo API

### Existing TopBar Component

[Source: components/layout/TopBar.tsx]

The TopBar already has a placeholder for RepoSelector:

```tsx
{/* RepoSelector placeholder - Epic 2 */}
<div className="hidden items-center gap-2 text-sm text-muted-foreground md:flex">
  <span className="rounded-lg border border-dashed border-border/50 px-3 py-1.5 text-xs">
    Selecteur de repo (Epic 2)
  </span>
</div>
```

### UX Requirements for RepoSelector

[Source: ux-design-specification.md]

**Anatomy:**
- GitHub icon
- Repo name (owner/name)
- Dropdown chevron
- Badge with branch

**States:**
- `default` - Repo displayed
- `hover` - Subtle background
- `open` - Dropdown with repo list
- `loading` - Skeleton during fetch

**Accessibility:**
- `role="combobox"` with `aria-expanded`
- Keyboard navigation in dropdown

### UX Requirements for TechTags

[Source: ux-design-specification.md]

**Anatomy:**
- Icon for technology (optional)
- Name of technology
- Colored background by category

**Color Categories:**
- Frontend: Blue (React, Vue, Angular)
- Backend: Green (Node, Python, Go)
- Database: Purple (PostgreSQL, MongoDB)
- DevOps: Orange (Docker, Kubernetes)

### Technology Detection Strategy

Use GitHub API data available from `GitHubRepo`:
1. `language` field - Primary language
2. For frameworks, would need to fetch `package.json`, `requirements.txt`, etc.

**MVP Approach:** Use primary language from GitHub API only. Framework detection can be added later.

### Project Structure for This Story

```
components/
├── layout/
│   ├── TopBar.tsx           # UPDATE: Integrate RepoSelector
│   ├── RepoSelector.tsx     # NEW: Repository selector dropdown
│   ├── TechTags.tsx         # NEW: Technology badges
│   └── index.ts             # UPDATE: Export new components

hooks/
├── useRepoTechnologies.ts   # NEW: Fetch repo technologies (optional)
└── index.ts                 # UPDATE: Export new hook
```

### Connected Repository Type

```typescript
interface ConnectedRepository {
  id: string
  user_id: string
  github_repo_id: string
  full_name: string        // "owner/repo"
  default_branch: string   // "main"
  is_active: boolean
  last_synced_at: string | null
  created_at: string
}
```

### Component Patterns

**RepoSelector Pattern:**
```tsx
<DropdownMenu>
  <DropdownMenuTrigger asChild>
    <Button variant="outline" className="gap-2">
      <GitHubIcon />
      <span>{repo.full_name}</span>
      <Badge variant="secondary">{repo.default_branch}</Badge>
      <ChevronDown />
    </Button>
  </DropdownMenuTrigger>
  <DropdownMenuContent>
    <DropdownMenuItem onClick={() => router.push('/repos')}>
      Changer de repository
    </DropdownMenuItem>
  </DropdownMenuContent>
</DropdownMenu>
```

**TechTags Pattern:**
```tsx
<div className="flex gap-1">
  {technologies.map((tech) => (
    <Badge
      key={tech}
      className={techColorMap[tech]}
    >
      {tech}
    </Badge>
  ))}
</div>
```

## Testing

### Test File Locations

- `components/layout/RepoSelector.test.tsx`
- `components/layout/TechTags.test.tsx`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Test rendering, interactions, and states

### Testing Requirements

**Unit Tests:**
- RepoSelector: render with repo data, dropdown open/close, navigation
- TechTags: render with multiple technologies, color mapping
- Loading and error states

**Manual Testing Checklist:**
1. Navigate to dashboard with connected repo
2. Verify RepoSelector shows repo name and branch
3. Click RepoSelector → verify dropdown opens
4. Click "Changer de repository" → verify navigation to /repos
5. Test on mobile → verify responsive behavior
6. Verify TechTags display primary language

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Initial story draft | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Created `RepoSelector` component with dropdown for active repository display
- Created `TechTags` component with colored badges for 20+ technologies
- Added `fetchRepoLanguages()` function to GitHub client using `/repos/{owner}/{repo}/languages` API
- Created `/api/repos/technologies` API route to fetch languages for active repo
- Created `useRepoTechnologies` React Query hook with 10-minute cache
- Integrated RepoSelector and TechTags in TopBar via DashboardShell
- Updated TopBar to accept repo, repoLoading, and technologies props
- TechTags hidden on mobile (lg:flex), repo names truncated
- All 128 tests passing, lint clean, build successful

### File List

**Created:**
- `components/layout/RepoSelector.tsx` - Repository selector dropdown component
- `components/layout/RepoSelector.test.tsx` - RepoSelector unit tests
- `components/layout/TechTags.tsx` - Technology badges component
- `components/layout/TechTags.test.tsx` - TechTags unit tests
- `app/api/repos/technologies/route.ts` - Technologies API endpoint
- `hooks/useRepoTechnologies.ts` - React Query hook for technologies

**Modified:**
- `components/layout/TopBar.tsx` - Added RepoSelector and TechTags integration
- `components/layout/TopBar.test.tsx` - Updated tests for new props
- `components/layout/DashboardShell.tsx` - Added useActiveRepo and useRepoTechnologies hooks
- `components/layout/index.ts` - Added exports for RepoSelector and TechTags
- `lib/github/client.ts` - Added fetchRepoLanguages function
- `lib/github/client.test.ts` - Added tests for fetchRepoLanguages
- `hooks/index.ts` - Added export for useRepoTechnologies

## QA Results
_To be filled by QA Agent_
