# Story 2.2: Connexion d'un Repository

## Status

In Progress (Indexation Integration)

## Story

**As a** utilisateur,
**I want** connecter un repository a mon compte,
**So that** je puisse commencer a poser des questions sur ce code.

## Acceptance Criteria

### Connexion (Implemented)

1. **Given** je vois la liste de mes repositories, **When** je clique sur un repository pour le connecter, **Then** le repository est enregistre dans ma base de donnees (table repositories)
2. **And** les metadonnees sont stockees (full_name, default_branch)
3. **And** je suis redirige vers l'interface de chat
4. **And** un toast confirme "Repository connecte"
5. **Given** le repository depasse 10 000 lignes de code, **When** je tente de le connecter, **Then** un avertissement s'affiche expliquant la limite MVP
6. **And** je peux quand meme proceder (avec disclaimer)
7. **Given** j'ai deja un repository connecte (MVP = 1 repo), **When** je connecte un nouveau repository, **Then** l'ancien repository est remplace par le nouveau
8. **And** les conversations precedentes restent accessibles

### Indexation (New - Story 2.5 Integration)

9. **Given** je connecte un repository, **When** la connexion est etablie, **Then** l'indexation du code demarre automatiquement en arriere-plan
10. **And** je vois une barre de progression indiquant l'avancement de l'indexation
11. **And** je peux utiliser le chat pendant l'indexation (mode degrade sans RAG)
12. **Given** l'indexation est terminee, **When** je regarde le header, **Then** un badge "Indexe" s'affiche a cote du repo
13. **Given** l'indexation echoue, **When** je vois l'erreur, **Then** un bouton "Reessayer" est disponible
14. **Given** je reconnecte un repository deja indexe, **When** la connexion est faite, **Then** l'indexation est relancee (mise a jour)

## Tasks / Subtasks

- [x] Task 1: Create Connect Repository API Route (AC: 1, 2, 4)
  - [x] Create `app/api/repos/connect/route.ts` with POST handler
  - [x] Validate request body with Zod schema (repoId, fullName, defaultBranch)
  - [x] Authenticate user via Supabase session
  - [x] Check if user already has an active repository (MVP = 1 repo)
  - [x] Insert or update repository in database via Prisma
  - [x] Return success response with repository data
  - [x] Handle errors with proper error codes

- [x] Task 2: Implement Repository Size Check (AC: 5, 6)
  - [x] Add function in `lib/github/client.ts` to count repo lines/size
  - [x] Use GitHub API to get repo size metadata
  - [x] Define threshold constant: 10,000 lines (MVP limit)
  - [x] Return warning flag when size exceeds limit
  - [x] Allow connection despite warning (with disclaimer)

- [x] Task 3: Handle Existing Repository Replacement (AC: 7, 8)
  - [x] Query existing active repository for user
  - [x] Set `is_active: false` on previous repository (soft delete)
  - [x] Preserve conversations linked to old repository
  - [x] Create new repository with `is_active: true`
  - [x] Ensure unique constraint on (user_id, github_repo_id)

- [x] Task 4: Update RepoCard Component to Connect (AC: 1, 3, 4)
  - [x] Add onClick handler to connect repository
  - [x] Call `/api/repos/connect` on click
  - [x] Show loading state during connection
  - [x] Display toast "Repository connecte" on success
  - [x] Navigate to `/dashboard` after successful connection (chat in Epic 3)
  - [x] Handle connection errors with user-friendly message

- [x] Task 5: Create Size Warning Dialog (AC: 5, 6)
  - [x] Create `components/repos/SizeWarningDialog.tsx`
  - [x] Display warning message about 10k line limit
  - [x] Explain potential performance implications
  - [x] Add "Continuer quand meme" and "Annuler" buttons
  - [x] Proceed with connection if user confirms

- [x] Task 6: Create useConnectRepo Hook (AC: 1, 4)
  - [x] Create `hooks/useConnectRepo.ts` with React Query mutation
  - [x] Configure mutation key: `['repos', 'connect']`
  - [x] Handle loading, success, and error states
  - [x] Invalidate repos query on success
  - [x] Return mutation function and state

- [x] Task 7: Add Active Repository Context (AC: 7)
  - [x] Create `contexts/ActiveRepoContext.tsx`
  - [x] Store active repository in context
  - [x] Provide `setActiveRepo` function
  - [x] Persist active repo ID in localStorage
  - [x] Load active repo on app initialization

- [x] Task 8: Create Get Active Repository API (AC: 7)
  - [x] Create `app/api/repos/active/route.ts` with GET handler
  - [x] Return user's active repository with metadata
  - [x] Return null if no repository connected
  - [x] Add `useActiveRepo` hook for fetching

- [x] Task 9: Unit Tests
  - [x] Test `lib/github/client.ts` size check function
  - [x] Test `useConnectRepo` hook
  - [x] Test SizeWarningDialog component
  - [x] Test fetchRepoDetails function

### Phase 2: Indexation Integration (New - Depends on Story 2.5)

- [ ] Task 10: Trigger Indexation After Connect (AC: 9)
  - [ ] Update `app/api/repos/connect/route.ts`
  - [ ] After successful repository upsert, call indexation pipeline
  - [ ] Start indexation as background job (non-blocking)
  - [ ] Return repository data immediately with `indexing_status: 'pending'`
  - [ ] Create indexing_job record in database

- [ ] Task 11: Update useConnectRepo Hook (AC: 9, 10, 11)
  - [ ] Update `hooks/useConnectRepo.ts`
  - [ ] Return indexing job ID in mutation response
  - [ ] Add `useIndexingStatus(jobId)` hook for polling
  - [ ] Poll every 2 seconds during indexation
  - [ ] Stop polling when status is 'completed' or 'failed'

- [ ] Task 12: Indexation Progress UI (AC: 10, 12, 13)
  - [ ] Create `components/repos/IndexingProgress.tsx`
  - [ ] Show progress bar with percentage and phase
  - [ ] Show "X fichiers traites sur Y"
  - [ ] Show "Indexe" badge when complete
  - [ ] Show error message + retry button on failure
  - [ ] Integrate in RepoSelector header component

- [ ] Task 13: Handle Re-indexation (AC: 14)
  - [ ] Detect if repository was previously indexed
  - [ ] Delete old embeddings before re-indexing
  - [ ] Preserve indexation if repo unchanged (check file hashes)
  - [ ] Add "Re-indexer" button in settings

- [ ] Task 14: Degraded Mode During Indexation (AC: 11)
  - [ ] Update chat API to check indexing status
  - [ ] If indexing in progress: use basic prompt (no RAG)
  - [ ] Show info banner: "Indexation en cours, reponses limitees"
  - [ ] Auto-refresh when indexation completes

- [ ] Task 15: Integration Tests (AC: 9-14)
  - [ ] Test full flow: connect → indexation starts → progress updates → completion
  - [ ] Test re-connection triggers re-indexation
  - [ ] Test chat in degraded mode during indexation
  - [ ] Test error handling and retry

## Dev Notes

### Previous Story Context (2.1)

Story 2.1 implemented the GitHub repository listing:
- API route `/api/repos` fetches user repos from GitHub API
- `useRepos` hook with React Query (5-min staleTime)
- `RepoCard`, `RepoList`, `RepoError` components
- Vercel KV cache with 5-min TTL
- Navigation link added to Sidebar

**Key files from 2.1:**
- `lib/github/client.ts` - GitHub API client with Octokit
- `lib/github/cache.ts` - Vercel KV caching
- `hooks/useRepos.ts` - React Query hook for repos
- `components/repos/` - RepoCard, RepoList, RepoError

### Database Schema (repositories table)

[Source: prisma/schema.prisma]

```prisma
model repositories {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String    @db.Uuid
  github_repo_id String
  full_name      String    // owner/repo format
  default_branch String    @default("main")
  is_active      Boolean   @default(true)
  last_synced_at DateTime? @db.Timestamptz(6)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)

  user          users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  conversations conversations[]

  @@unique([user_id, github_repo_id])
  @@map("repositories")
}
```

**Important:** The `is_active` field allows soft-switching between repositories. Only one repository should be active per user for MVP.

### GitHub Token Access Pattern

[Source: architecture.md#Authentication & Security]

```typescript
// Access GitHub token from Supabase session
const supabase = await createClient()
const { data: { session } } = await supabase.auth.getSession()
const githubToken = session?.provider_token // Direct access!
const userId = session?.user.id
```

### Connect Repository API Pattern

```typescript
// app/api/repos/connect/route.ts
import { createClient } from '@/lib/supabase/server'
import { prisma } from '@/lib/prisma'
import { NextResponse } from 'next/server'
import { z } from 'zod'

const connectSchema = z.object({
  repoId: z.number(),
  fullName: z.string(),
  defaultBranch: z.string().default('main'),
})

export async function POST(req: Request) {
  const supabase = await createClient()
  const { data: { session } } = await supabase.auth.getSession()

  if (!session) {
    return NextResponse.json(
      { error: { code: 'UNAUTHORIZED', message: 'Non authentifie' } },
      { status: 401 }
    )
  }

  const body = await req.json()
  const { repoId, fullName, defaultBranch } = connectSchema.parse(body)

  // Deactivate existing active repository
  await prisma.repositories.updateMany({
    where: { user_id: session.user.id, is_active: true },
    data: { is_active: false }
  })

  // Connect new repository (upsert)
  const repository = await prisma.repositories.upsert({
    where: {
      user_id_github_repo_id: {
        user_id: session.user.id,
        github_repo_id: String(repoId)
      }
    },
    create: {
      user_id: session.user.id,
      github_repo_id: String(repoId),
      full_name: fullName,
      default_branch: defaultBranch,
      is_active: true,
    },
    update: {
      is_active: true,
      default_branch: defaultBranch,
    }
  })

  return NextResponse.json(repository)
}
```

### useConnectRepo Hook Pattern

```typescript
// hooks/useConnectRepo.ts
import { useMutation, useQueryClient } from '@tanstack/react-query'

interface ConnectRepoParams {
  repoId: number
  fullName: string
  defaultBranch: string
}

async function connectRepo(params: ConnectRepoParams) {
  const res = await fetch('/api/repos/connect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(params),
  })
  if (!res.ok) {
    const error = await res.json()
    throw new Error(error.error?.message || 'Failed to connect repo')
  }
  return res.json()
}

export function useConnectRepo() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: connectRepo,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['repos'] })
      queryClient.invalidateQueries({ queryKey: ['activeRepo'] })
    },
  })
}
```

### UX Requirements

[Source: ux-design-specification.md]

- **Toast notification:** "Repository connecte" on success
- **Navigation:** Redirect to `/chat` after connection
- **Warning dialog:** Professional, not alarming, for size limit
- **Loading state:** Visual feedback during connection
- **Error handling:** User-friendly messages, retry option

### Project Structure for This Story

```
app/
├── api/
│   └── repos/
│       ├── route.ts          # EXISTS: GET list repos
│       ├── connect/
│       │   └── route.ts      # NEW: POST connect repo
│       └── active/
│           └── route.ts      # NEW: GET active repo

components/
├── repos/
│   ├── RepoCard.tsx          # UPDATE: Add connect handler
│   ├── SizeWarningDialog.tsx # NEW: Size warning dialog
│   └── ...

contexts/
├── ActiveRepoContext.tsx     # NEW: Active repo context

hooks/
├── useConnectRepo.ts         # NEW: Connect mutation hook
├── useActiveRepo.ts          # NEW: Active repo query hook
└── ...
```

### Error Codes Reference

| Code | HTTP Status | Message |
|------|-------------|---------|
| `UNAUTHORIZED` | 401 | Non authentifie |
| `VALIDATION_ERROR` | 400 | Donnees invalides |
| `REPO_NOT_FOUND` | 404 | Repository introuvable |
| `CONNECT_FAILED` | 500 | Impossible de connecter le repository |

---

## Phase 2: Indexation Integration

### Dependency on Story 2.5

This phase requires Story 2.5 (Indexation du Code avec Embeddings) to be implemented first. The following components from 2.5 are used:

- `lib/indexing/pipeline.ts` - Main indexation orchestrator
- `lib/indexing/job-manager.ts` - Job status tracking
- `app/api/repos/[repoId]/index/route.ts` - Indexation API
- Database tables: `code_chunks`, `indexing_jobs`

### Updated Connect Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    CONNEXION + INDEXATION                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. User clicks "Connect" on RepoCard                           │
│     │                                                            │
│     ▼                                                            │
│  2. POST /api/repos/connect                                      │
│     ├── Deactivate previous repo                                │
│     ├── Upsert new repository                                   │
│     └── Start indexation job (background)                       │
│     │                                                            │
│     ▼                                                            │
│  3. Return { repository, indexing_job_id, indexing_status }     │
│     │                                                            │
│     ▼                                                            │
│  4. Redirect to /chat                                           │
│     │                                                            │
│     ├──► Chat usable immediately (degraded mode)                │
│     │                                                            │
│     └──► IndexingProgress polls status every 2s                 │
│          │                                                       │
│          ▼                                                       │
│  5. When indexation complete:                                    │
│     ├── Show "Indexe" badge                                     │
│     └── Chat switches to RAG mode (full context)                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Updated Connect API Response

```typescript
// app/api/repos/connect/route.ts - Updated response

interface ConnectResponse {
  repository: {
    id: string
    full_name: string
    default_branch: string
    is_active: boolean
  }
  indexing: {
    job_id: string
    status: 'pending' | 'processing' | 'completed' | 'failed'
  }
}
```

### IndexingProgress Component

```typescript
// components/repos/IndexingProgress.tsx

interface IndexingProgressProps {
  repositoryId: string
  onComplete?: () => void
}

// States:
// - pending: "Preparation de l'indexation..."
// - fetching: "Recuperation des fichiers..." (X/Y)
// - parsing: "Analyse du code..." (X/Y fichiers)
// - embedding: "Generation des embeddings..." (X%)
// - completed: Badge "Indexe" vert
// - failed: Message d'erreur + bouton "Reessayer"
```

### Chat Degraded Mode

```typescript
// app/api/chat/route.ts - Check indexing status

const indexingJob = await prisma.indexing_jobs.findUnique({
  where: { repository_id: repoId }
})

const isIndexed = indexingJob?.status === 'completed'

if (!isIndexed) {
  // Use basic prompt without RAG context
  // Add note to response: "Indexation en cours..."
}
```

### Re-indexation Logic

```typescript
// Trigger re-indexation when:
// 1. User explicitly clicks "Re-indexer"
// 2. Repository is reconnected (detected via is_active toggle)
// 3. Manual refresh requested

// Before re-indexing:
// 1. Delete existing code_chunks for this repository
// 2. Reset indexing_job status to 'pending'
// 3. Start new indexation pipeline
```

## Testing

### Test File Locations

- `app/api/repos/connect/route.test.ts` - API route tests
- `components/repos/SizeWarningDialog.test.tsx` - Component tests
- `hooks/useConnectRepo.test.tsx` - Hook tests

### Test Standards

[Source: architecture.md#Project Structure]

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Mock Prisma client for database operations
- Test both success and error paths

### Testing Requirements for This Story

**Unit Tests:**
- API route: connect new repo, replace existing, validation errors
- Size check: mock GitHub API, test threshold logic
- Hook: loading state, success callback, error handling
- Dialog: render, button clicks, proceed/cancel

**Manual Testing Checklist:**
1. Navigate to `/repos` when authenticated
2. Click on a repository card
3. Verify loading state appears
4. Verify toast "Repository connecte" appears
5. Verify redirect to `/chat`
6. Click on a different repo - verify old one deactivated
7. For large repos - verify size warning dialog appears
8. Confirm size warning - verify connection proceeds

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Initial story draft | SM Agent |
| 2026-01-12 | 0.2 | Added Phase 2: Indexation Integration (AC 9-14, Tasks 10-15) | SM Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
N/A - No debug issues encountered

### Completion Notes List
- Created POST `/api/repos/connect` endpoint with Zod validation
- Implemented repository replacement logic (MVP = 1 active repo)
- Added size check function `checkRepoSizeWarning()` with 500KB threshold (~10k lines)
- Added `fetchRepoDetails()` for fetching single repo metadata
- Created `useConnectRepo` mutation hook with React Query
- Created `useActiveRepo` query hook for fetching active repository
- Created `ActiveRepoContext` for app-wide active repo state with localStorage persistence
- Created `SizeWarningDialog` component for large repo warnings
- Updated `/repos` page with full connection flow including size warning dialog
- Navigation redirects to `/dashboard` after connection (chat page in Epic 3)
- All 103 tests passing, lint clean, build successful

### File List

**Created:**
- `app/api/repos/connect/route.ts` - Connect repository API endpoint
- `app/api/repos/active/route.ts` - Get active repository API endpoint
- `hooks/useConnectRepo.ts` - React Query mutation hook
- `hooks/useConnectRepo.test.tsx` - Hook tests
- `hooks/useActiveRepo.ts` - React Query query hook
- `contexts/ActiveRepoContext.tsx` - Active repository context provider
- `components/repos/SizeWarningDialog.tsx` - Size warning dialog component
- `components/repos/SizeWarningDialog.test.tsx` - Dialog tests

**Modified:**
- `lib/github/client.ts` - Added `checkRepoSizeWarning()`, `fetchRepoDetails()`, `REPO_SIZE_WARNING_THRESHOLD_KB`
- `lib/github/client.test.ts` - Added tests for new functions
- `hooks/index.ts` - Added exports for new hooks
- `components/repos/index.ts` - Added export for SizeWarningDialog
- `app/(dashboard)/repos/page.tsx` - Added connection flow with size warning dialog

## QA Results
_To be filled by QA Agent_
