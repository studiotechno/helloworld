# Story 3.4: Creation de Nouvelle Conversation

## Status

Ready for Review

## Story

**As a** utilisateur,
**I want** demarrer une nouvelle conversation a tout moment,
**So that** je puisse poser des questions sur un nouveau sujet.

## Acceptance Criteria

1. **Given** je suis dans une conversation existante, **When** je clique sur "Nouvelle conversation" ou ⌘+N, **Then** une nouvelle conversation vide est creee
2. **And** l'EmptyState avec suggestions s'affiche
3. **And** l'ancienne conversation reste accessible dans la sidebar
4. **Given** je clique sur une suggestion dans l'EmptyState, **When** la suggestion est selectionnee, **Then** le texte de la suggestion est insere dans le champ de saisie
5. **And** je peux modifier avant d'envoyer ou envoyer directement

## Tasks / Subtasks

- [x] Task 1: Add ⌘+N Keyboard Shortcut for New Conversation (AC: 1)
  - [x] Create `hooks/use-keyboard-shortcuts.ts` for centralized keyboard shortcut handling
  - [x] Implement ⌘+N (Mac) / Ctrl+N (Windows) detection
  - [x] Navigate to `/chat` when shortcut is triggered
  - [x] Ensure shortcut works globally across all dashboard pages
  - [x] Add to DashboardShell or a global provider

- [x] Task 2: Add Keyboard Hint to Sidebar Button (AC: 1)
  - [x] Update Sidebar "Nouvelle conversation" button tooltip to show (⌘+N)
  - [x] Match existing pattern from ⌘+B sidebar toggle hint

- [x] Task 3: Verify EmptyState and Suggestion Flow (AC: 2, 4, 5)
  - [x] Confirm EmptyState displays when navigating to /chat
  - [x] Verify SuggestionChips click inserts text into ChatInput
  - [x] Confirm user can edit text before sending
  - [x] Confirm user can send directly without editing

- [x] Task 4: Verify Conversation Persistence in Sidebar (AC: 3)
  - [x] Confirm old conversations remain in sidebar after creating new
  - [x] Verify navigation to old conversations still works
  - [x] Check that conversation list updates correctly

- [x] Task 5: Unit Tests (AC: 1)
  - [x] Test useKeyboardShortcuts hook
  - [x] Test ⌘+N triggers navigation
  - [x] Test Ctrl+N works on Windows

## Dev Notes

### Previous Story Context (3.3)

Story 3.3 implemented:
- Conversations API routes at `app/api/conversations/`
- Messages persistence with `onFinish` callback in chat API
- `useConversations` and `useConversation` hooks in `hooks/use-conversations.ts`
- Conversation list displayed in Sidebar component
- Redirect to `/chat/[conversationId]` after first message

Key files from Story 3.3:
- `app/api/conversations/route.ts` - POST create, GET list conversations
- `app/api/conversations/[conversationId]/messages/route.ts` - GET messages
- `hooks/use-conversations.ts` - React Query hooks for conversations
- `components/layout/Sidebar.tsx` - Displays conversation list

### Existing Implementation Analysis

**Already Implemented (from Stories 3.1-3.3):**

1. **"Nouvelle conversation" Button** - `components/layout/Sidebar.tsx:84-103`
   - Button exists with `onClick={() => router.push('/chat')}`
   - Has tooltip when sidebar is collapsed
   - Styled with pink glow effect

2. **EmptyState Component** - `components/chat/EmptyState.tsx`
   - Displays gradient title "Posez votre premiere question"
   - Shows SuggestionChips with 4 default suggestions
   - `onSuggestionClick` prop handled by parent

3. **Suggestion Click Flow** - `app/(dashboard)/chat/page.tsx:111-113`
   - `handleSuggestionClick` sets `inputValue` state
   - Input value passed to ChatInput component
   - User can modify or send directly

4. **Conversation List in Sidebar** - `components/layout/Sidebar.tsx:130-216`
   - Uses `useConversations()` hook
   - Shows loading state, empty state, or conversation list
   - Highlights active conversation based on pathname

**Missing Implementation:**

1. **⌘+N Keyboard Shortcut** - Not implemented anywhere
   - Need global keyboard listener
   - Should navigate to `/chat`
   - Must work from any dashboard page

### Keyboard Shortcuts Pattern [Source: ux-design-specification.md#keyboard-shortcuts]

From UX specification:
```
| Raccourci | Action |
|-----------|--------|
| ⌘ + Enter | Envoyer message |
| ⌘ + E | Exporter conversation |
| ⌘ + B | Toggle sidebar |
| ⌘ + N | Nouvelle conversation |
| Escape | Fermer modal/dropdown |
```

**Existing ⌘+B Implementation** - `components/layout/Sidebar.tsx:31-42`:
```typescript
useEffect(() => {
  const handleKeyDown = (event: KeyboardEvent) => {
    if ((event.metaKey || event.ctrlKey) && event.key === 'b') {
      event.preventDefault()
      onToggle()
    }
  }

  document.addEventListener('keydown', handleKeyDown)
  return () => document.removeEventListener('keydown', handleKeyDown)
}, [onToggle])
```

This pattern should be replicated for ⌘+N.

### Component Structure [Source: architecture.md#component-architecture]

```
components/
├── layout/
│   ├── Sidebar.tsx          # UPDATE: Add ⌘+N hint to tooltip
│   └── DashboardShell.tsx   # UPDATE: Add global keyboard shortcuts
│
hooks/
├── use-keyboard-shortcuts.ts # NEW: Centralized shortcut handling
└── index.ts                  # UPDATE: Export new hook
```

### Hooks Pattern [Source: architecture.md#naming-patterns]

```typescript
// hooks/use-keyboard-shortcuts.ts
import { useEffect } from 'react'
import { useRouter } from 'next/navigation'

interface KeyboardShortcut {
  key: string
  metaKey?: boolean
  ctrlKey?: boolean
  action: () => void
}

export function useKeyboardShortcuts(shortcuts: KeyboardShortcut[]) {
  const router = useRouter()

  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      for (const shortcut of shortcuts) {
        const metaMatch = shortcut.metaKey ? (event.metaKey || event.ctrlKey) : true
        if (metaMatch && event.key.toLowerCase() === shortcut.key.toLowerCase()) {
          event.preventDefault()
          shortcut.action()
          return
        }
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [shortcuts])
}

// Usage in DashboardShell:
export function useNewConversationShortcut() {
  const router = useRouter()

  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if ((event.metaKey || event.ctrlKey) && event.key === 'n') {
        event.preventDefault()
        router.push('/chat')
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [router])
}
```

### Project Structure for This Story

```
app/
├── (dashboard)/
│   └── layout.tsx            # Could add global shortcuts here
│
components/
├── layout/
│   ├── Sidebar.tsx           # UPDATE: Tooltip text
│   └── DashboardShell.tsx    # UPDATE: Add useNewConversationShortcut
│
hooks/
├── use-keyboard-shortcuts.ts # NEW
└── index.ts                  # UPDATE
```

### Testing Requirements [Source: architecture.md#testing]

**Unit Tests:**
- `hooks/use-keyboard-shortcuts.test.ts`
  - Test ⌘+N triggers navigation on Mac
  - Test Ctrl+N triggers navigation on Windows
  - Test preventDefault is called
  - Test cleanup on unmount

**Test Framework:** Vitest + Testing Library

### Technical Constraints

1. **Browser Default Override**: ⌘+N normally opens a new browser window. We must `preventDefault()` to override this.

2. **Input Focus Handling**: When user is typing in an input, we should NOT intercept ⌘+N. Check if `document.activeElement` is an input/textarea before triggering.

3. **Cross-Browser Support**: Use `event.metaKey` for Mac and `event.ctrlKey` for Windows/Linux.

## Testing

### Test File Locations

- `hooks/use-keyboard-shortcuts.test.ts`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Mock `useRouter` for navigation tests

### Manual Testing Checklist

1. [ ] Press ⌘+N from /chat → navigates to new /chat (fresh EmptyState)
2. [ ] Press ⌘+N from /chat/[id] → navigates to /chat
3. [ ] Press Ctrl+N on Windows → same behavior
4. [ ] While typing in ChatInput, ⌘+N should NOT trigger (optional - discuss)
5. [ ] Click suggestion → text inserted in input
6. [ ] Modify inserted text → works
7. [ ] Send inserted text directly → works
8. [ ] Old conversations remain in sidebar
9. [ ] Can navigate to old conversations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 0.1 | Initial story draft | SM Agent |
| 2026-01-10 | 0.2 | Implementation complete | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- No major issues encountered during implementation
- Used existing ⌘+B keyboard shortcut pattern from Sidebar as template
- Added input focus safeguard to prevent shortcut triggering while typing

### Completion Notes List
- All 5 tasks completed successfully
- 217 tests passing (1 pre-existing failure in DeleteAccountDialog)
- Build successful
- Lint passing
- Created keyboard shortcut hook with input focus protection
- Updated Sidebar tooltip to show ⌘+N hint
- Tasks 3-4 were verification of existing functionality

### File List
**Created:**
- `hooks/use-keyboard-shortcuts.ts` - New conversation keyboard shortcut hook
- `hooks/use-keyboard-shortcuts.test.ts` - Unit tests (8 tests)

**Modified:**
- `hooks/index.ts` - Export new hook
- `components/layout/DashboardShell.tsx` - Use keyboard shortcut hook
- `components/layout/Sidebar.tsx` - Add ⌘+N hint to tooltip

## QA Results
_To be filled by QA Agent_
