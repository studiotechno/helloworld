# Story 3.2: Envoi de Messages & Streaming des Reponses

## Status

Done

## Story

**As a** utilisateur,
**I want** poser une question et voir la reponse apparaitre progressivement,
**So that** l'attente soit reduite et l'interaction soit fluide.

## Acceptance Criteria

1. **Given** je suis sur l'interface de chat, **When** j'envoie une question, **Then** mon message apparait immediatement (bulle rose avec glow)
2. **And** un TypingIndicator avec dots qui bounce s'affiche
3. **And** la reponse de l'assistant apparait en streaming (mot par mot)
4. **And** le message assistant a un fond transparent, aligne a gauche
5. **Given** la reponse est en cours de streaming, **When** je scrolle vers le haut, **Then** le scroll automatique vers le bas s'arrete
6. **And** un bouton "Retour en bas" apparait
7. **Given** l'API Claude est indisponible, **When** j'envoie un message, **Then** un message d'erreur explicatif s'affiche
8. **And** je peux reessayer

## Tasks / Subtasks

- [x] Task 1: Create Chat API Route with Streaming (AC: 3, 7, 8)
  - [x] Create `app/api/chat/route.ts` with POST handler
  - [x] Use Vercel AI SDK with `streamText` from `@ai-sdk/anthropic`
  - [x] Authenticate user via `getCurrentUser()`
  - [x] Validate request body with Zod (messages array, repoId optional)
  - [x] Build system prompt for codebase assistant
  - [x] Return `result.toUIMessageStreamResponse()` for streaming (v6 API)
  - [x] Handle errors gracefully with user-friendly messages

- [x] Task 2: Create ChatMessage Component (AC: 1, 4)
  - [x] Create `components/chat/ChatMessage.tsx`
  - [x] Support `role: 'user' | 'assistant'` variants
  - [x] User messages: rose bubble with glow, aligned right
  - [x] Assistant messages: transparent background, aligned left
  - [x] Support markdown rendering in content
  - [x] Add copy button on hover

- [x] Task 3: Create TypingIndicator Component (AC: 2)
  - [x] Create `components/chat/TypingIndicator.tsx`
  - [x] Implement bouncing dots animation (not just pulse)
  - [x] Style consistent with chat design

- [x] Task 4: Create ScrollToBottom Button (AC: 5, 6)
  - [x] Create `components/chat/ScrollToBottom.tsx`
  - [x] Show button when user scrolls up during streaming
  - [x] Hide when at bottom
  - [x] Smooth scroll on click

- [x] Task 5: Integrate useChat Hook in Chat Page (AC: 1, 2, 3, 5)
  - [x] Update `app/(dashboard)/chat/page.tsx` to use `useChat` from `@ai-sdk/react`
  - [x] Connect to `/api/chat` endpoint via `DefaultChatTransport`
  - [x] Display messages with ChatMessage component
  - [x] Show TypingIndicator while streaming
  - [x] Implement auto-scroll with pause on manual scroll
  - [x] Handle empty state vs messages state

- [x] Task 6: Update Chat Index Exports
  - [x] Export ChatMessage, TypingIndicator, ScrollToBottom from index

- [x] Task 7: Unit Tests
  - [x] Test ChatMessage rendering for user and assistant roles
  - [x] Test TypingIndicator animation
  - [x] Test ScrollToBottom visibility logic
  - [x] Test markdown rendering and copy functionality

## Dev Notes

### Previous Story Context (3.1)

Story 3.1 implemented the base chat interface:
- `ChatContainer` - Centered container (max 800px)
- `ChatInput` - Controlled textarea with auto-resize
- `EmptyState` - Gradient title and suggestions
- `SuggestionChips` - Clickable question suggestions
- Chat pages at `/chat` and `/chat/[conversationId]`

**Key files from Story 3.1:**
- `components/chat/ChatContainer.tsx`
- `components/chat/ChatInput.tsx`
- `components/chat/EmptyState.tsx`
- `app/(dashboard)/chat/page.tsx`

### Vercel AI SDK Integration

The project already has AI SDK installed:
- `ai`: ^6.0.25
- `@ai-sdk/anthropic`: ^3.0.9

**useChat Hook Pattern:**
```tsx
import { useChat } from 'ai/react'

const { messages, input, handleInputChange, handleSubmit, isLoading, error } = useChat({
  api: '/api/chat',
  body: { repoId: activeRepo?.id },
})
```

### Chat API Route Pattern

```typescript
// app/api/chat/route.ts
import { streamText } from 'ai'
import { anthropic } from '@ai-sdk/anthropic'
import { getCurrentUser } from '@/lib/auth/sync-user'

export async function POST(req: Request) {
  const user = await getCurrentUser()
  if (!user) {
    return new Response('Unauthorized', { status: 401 })
  }

  const { messages } = await req.json()

  const result = await streamText({
    model: anthropic('claude-sonnet-4-20250514'),
    messages,
    system: `Tu es un assistant qui aide les Product Managers a comprendre leur codebase.
Tu reponds en francais avec un vocabulaire professionnel.
Tu es pedagogique et tu expliques les concepts techniques de maniere accessible.
Si tu n'es pas sur d'une reponse, dis-le clairement.`,
  })

  return result.toDataStreamResponse()
}
```

### ChatMessage Component Design

From UX Specification:
- **User messages**: Rose bubble (#EC4899) with glow shadow, aligned right
- **Assistant messages**: Transparent background, aligned left
- Both support markdown rendering
- Copy button appears on hover

```tsx
// Variant styling
const variants = {
  user: 'ml-auto bg-primary text-primary-foreground rounded-2xl rounded-br-sm shadow-lg shadow-primary/25',
  assistant: 'mr-auto bg-transparent',
}
```

### TypingIndicator Design

From UX Specification:
- Dots that **bounce** (not just pulse)
- 3 dots with staggered animation
- Rose color matching the theme

```tsx
// Bouncing animation
<div className="flex gap-1">
  <span className="animate-bounce [animation-delay:-0.3s]">.</span>
  <span className="animate-bounce [animation-delay:-0.15s]">.</span>
  <span className="animate-bounce">.</span>
</div>
```

### Auto-Scroll Logic

```tsx
const scrollAreaRef = useRef<HTMLDivElement>(null)
const [userScrolled, setUserScrolled] = useState(false)

// Track if user has scrolled up
const handleScroll = () => {
  if (scrollAreaRef.current) {
    const { scrollTop, scrollHeight, clientHeight } = scrollAreaRef.current
    const isAtBottom = scrollHeight - scrollTop - clientHeight < 100
    setUserScrolled(!isAtBottom)
  }
}

// Auto-scroll when new content arrives (unless user scrolled up)
useEffect(() => {
  if (!userScrolled && scrollAreaRef.current) {
    scrollAreaRef.current.scrollTop = scrollAreaRef.current.scrollHeight
  }
}, [messages, userScrolled])
```

### Project Structure for This Story

```
app/
├── api/
│   └── chat/
│       └── route.ts              # NEW: POST streaming chat
├── (dashboard)/
│   └── chat/
│       └── page.tsx              # UPDATE: Use useChat hook

components/
├── chat/
│   ├── ChatMessage.tsx           # NEW: Message bubble component
│   ├── ChatMessage.test.tsx      # NEW: Tests
│   ├── TypingIndicator.tsx       # NEW: Bouncing dots
│   ├── TypingIndicator.test.tsx  # NEW: Tests
│   ├── ScrollToBottom.tsx        # NEW: Scroll button
│   ├── ScrollToBottom.test.tsx   # NEW: Tests
│   └── index.ts                  # UPDATE: New exports
```

### Environment Requirements

The API route requires `ANTHROPIC_API_KEY` to be set in `.env.local`:
```
ANTHROPIC_API_KEY=sk-ant-...
```

### Error Handling Strategy

1. **Authentication error**: Return 401, show "Please log in" message
2. **Rate limit**: Return 429, show "Too many requests" with retry
3. **API error**: Return 500, show generic error with retry button
4. **Network error**: Catch in useChat, show connection error

## Testing

### Test File Locations

- `app/api/chat/route.test.ts`
- `components/chat/ChatMessage.test.tsx`
- `components/chat/TypingIndicator.test.tsx`
- `components/chat/ScrollToBottom.test.tsx`

### Test Standards

- Test framework: Vitest + Testing Library
- Co-located tests next to source files
- Mock AI SDK for API route tests

### Testing Requirements

**Unit Tests:**
- ChatMessage: user vs assistant styling, markdown rendering, copy button
- TypingIndicator: renders bouncing dots
- ScrollToBottom: visibility based on scroll position
- API route: auth check, streaming response, error handling

**Manual Testing Checklist:**
1. Navigate to /chat with connected repo
2. Type a message and send -> see user message appear immediately
3. Verify TypingIndicator shows while waiting
4. Verify assistant response streams word by word
5. Scroll up during streaming -> verify auto-scroll stops
6. Verify "Retour en bas" button appears
7. Click button -> smooth scroll to bottom
8. Test with invalid API key -> verify error message
9. Test retry functionality

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-09 | 0.1 | Initial story draft | SM Agent |
| 2026-01-09 | 1.0 | Implementation completed | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- AI SDK v6 breaking changes required multiple fixes:
  - `ai/react` -> `@ai-sdk/react` (separate package)
  - `useChat` API changed: no more `input`/`handleSubmit`/`isLoading`, uses `sendMessage`, `status`, and `messages.parts` array
  - `DefaultChatTransport` required instead of `api` option
  - `sendMessage({ text })` instead of `sendMessage({ content })`
  - `maxTokens` -> `maxOutputTokens`
  - `toDataStreamResponse()` -> `toUIMessageStreamResponse()`
  - Zod `.errors` -> `.issues`

### Completion Notes List
- All 7 tasks completed successfully
- 195 tests passing
- Build successful
- Lint passing
- Installed additional package: `react-markdown` for markdown rendering
- Used `@ai-sdk/react` for useChat hook integration

### File List
**Created:**
- `app/api/chat/route.ts` - Chat API with streaming using Anthropic Claude
- `components/chat/ChatMessage.tsx` - User/assistant message display with markdown
- `components/chat/ChatMessage.test.tsx` - Unit tests (10 tests)
- `components/chat/TypingIndicator.tsx` - Bouncing dots animation
- `components/chat/TypingIndicator.test.tsx` - Unit tests (6 tests)
- `components/chat/ScrollToBottom.tsx` - Scroll to bottom button
- `components/chat/ScrollToBottom.test.tsx` - Unit tests (7 tests)

**Modified:**
- `app/(dashboard)/chat/page.tsx` - Integrated useChat hook with AI SDK v6
- `components/chat/index.ts` - Added new component exports

## QA Results
_To be filled by QA Agent_
